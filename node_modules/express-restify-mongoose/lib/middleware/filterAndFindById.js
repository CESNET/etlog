'use strict';

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var http = require('http');

module.exports = function (model, options) {
  var errorHandler = require('../errorHandler')(options);

  return function (req, res, next) {
    if (!req.params.id) {
      return next();
    }

    options.contextFilter(model, req, function (filteredContext) {
      filteredContext.findOne().and(_defineProperty({}, options.idProperty, req.params.id)).lean(false).read(options.readPreference).exec().then(function (doc) {
        if (!doc) {
          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]));
        }

        req.erm.document = doc;

        next();
      }, errorHandler(req, res, next));
    });
  };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL2ZpbHRlckFuZEZpbmRCeUlkLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxJQUFNLE9BQU8sUUFBUSxNQUFSLENBQWI7O0FBRUEsT0FBTyxPQUFQLEdBQWlCLFVBQVUsS0FBVixFQUFpQixPQUFqQixFQUEwQjtBQUN6QyxNQUFNLGVBQWUsUUFBUSxpQkFBUixFQUEyQixPQUEzQixDQUFyQjs7QUFFQSxTQUFPLFVBQVUsR0FBVixFQUFlLEdBQWYsRUFBb0IsSUFBcEIsRUFBMEI7QUFDL0IsUUFBSSxDQUFDLElBQUksTUFBSixDQUFXLEVBQWhCLEVBQW9CO0FBQ2xCLGFBQU8sTUFBUDtBQUNEOztBQUVELFlBQVEsYUFBUixDQUFzQixLQUF0QixFQUE2QixHQUE3QixFQUFrQyxVQUFDLGVBQUQsRUFBcUI7QUFDckQsc0JBQWdCLE9BQWhCLEdBQTBCLEdBQTFCLHFCQUNHLFFBQVEsVUFEWCxFQUN3QixJQUFJLE1BQUosQ0FBVyxFQURuQyxHQUVHLElBRkgsQ0FFUSxLQUZSLEVBRWUsSUFGZixDQUVvQixRQUFRLGNBRjVCLEVBRTRDLElBRjVDLEdBRW1ELElBRm5ELENBRXdELFVBQUMsR0FBRCxFQUFTO0FBQy9ELFlBQUksQ0FBQyxHQUFMLEVBQVU7QUFDUixpQkFBTyxhQUFhLEdBQWIsRUFBa0IsR0FBbEIsRUFBdUIsSUFBdkIsRUFBNkIsSUFBSSxLQUFKLENBQVUsS0FBSyxZQUFMLENBQWtCLEdBQWxCLENBQVYsQ0FBN0IsQ0FBUDtBQUNEOztBQUVELFlBQUksR0FBSixDQUFRLFFBQVIsR0FBbUIsR0FBbkI7O0FBRUE7QUFDRCxPQVZELEVBVUcsYUFBYSxHQUFiLEVBQWtCLEdBQWxCLEVBQXVCLElBQXZCLENBVkg7QUFXRCxLQVpEO0FBYUQsR0FsQkQ7QUFtQkQsQ0F0QkQiLCJmaWxlIjoiZmlsdGVyQW5kRmluZEJ5SWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBodHRwID0gcmVxdWlyZSgnaHR0cCcpXHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykge1xyXG4gIGNvbnN0IGVycm9ySGFuZGxlciA9IHJlcXVpcmUoJy4uL2Vycm9ySGFuZGxlcicpKG9wdGlvbnMpXHJcblxyXG4gIHJldHVybiBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcclxuICAgIGlmICghcmVxLnBhcmFtcy5pZCkge1xyXG4gICAgICByZXR1cm4gbmV4dCgpXHJcbiAgICB9XHJcblxyXG4gICAgb3B0aW9ucy5jb250ZXh0RmlsdGVyKG1vZGVsLCByZXEsIChmaWx0ZXJlZENvbnRleHQpID0+IHtcclxuICAgICAgZmlsdGVyZWRDb250ZXh0LmZpbmRPbmUoKS5hbmQoe1xyXG4gICAgICAgIFtvcHRpb25zLmlkUHJvcGVydHldOiByZXEucGFyYW1zLmlkXHJcbiAgICAgIH0pLmxlYW4oZmFsc2UpLnJlYWQob3B0aW9ucy5yZWFkUHJlZmVyZW5jZSkuZXhlYygpLnRoZW4oKGRvYykgPT4ge1xyXG4gICAgICAgIGlmICghZG9jKSB7XHJcbiAgICAgICAgICByZXR1cm4gZXJyb3JIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KShuZXcgRXJyb3IoaHR0cC5TVEFUVVNfQ09ERVNbNDA0XSkpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXEuZXJtLmRvY3VtZW50ID0gZG9jXHJcblxyXG4gICAgICAgIG5leHQoKVxyXG4gICAgICB9LCBlcnJvckhhbmRsZXIocmVxLCByZXMsIG5leHQpKVxyXG4gICAgfSlcclxuICB9XHJcbn1cclxuIl19
//# sourceMappingURL=filterAndFindById.js.map