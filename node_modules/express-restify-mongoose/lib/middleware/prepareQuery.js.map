{"version":3,"sources":["../../src/middleware/prepareQuery.js"],"names":[],"mappings":"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","file":"prepareQuery.js","sourcesContent":["const _ = require('lodash')\r\nconst isCoordinates = require('is-coordinates')\r\n\r\nmodule.exports = function (options) {\r\n  const errorHandler = require('../errorHandler')(options)\r\n\r\n  function jsonQueryParser (key, value) {\r\n    if (key === '$regex' && !options.allowRegex) {\r\n      return undefined\r\n    }\r\n\r\n    if (_.isString(value)) {\r\n      if (value[0] === '~') { // parse RegExp\r\n        return options.allowRegex ? new RegExp(value.substr(1), 'i') : undefined\r\n      } else if (value[0] === '>') {\r\n        if (value[1] === '=') {\r\n          return { $gte: value.substr(2) }\r\n        } else {\r\n          return { $gt: value.substr(1) }\r\n        }\r\n      } else if (value[0] === '<') {\r\n        if (value[1] === '=') {\r\n          return { $lte: value.substr(2) }\r\n        } else {\r\n          return { $lt: value.substr(1) }\r\n        }\r\n      } else if (value[0] === '!' && value[1] === '=') {\r\n        return { $ne: value.substr(2) }\r\n      /* This feature was disabled because it requires MongoDB 3\r\n      } else if (value[0] === '=') {\r\n        return { $eq: value.substr(1) }*/\r\n      }\r\n    } else if (_.isArray(value) && key[0] !== '$' && key !== 'coordinates' && !isCoordinates(value)) {\r\n      return { $in: value }\r\n    }\r\n\r\n    return value\r\n  }\r\n\r\n  function parseQueryOptions (queryOptions) {\r\n    if (queryOptions.select && _.isString(queryOptions.select)) {\r\n      let select = queryOptions.select.split(',')\r\n      queryOptions.select = {}\r\n\r\n      for (let i = 0, length = select.length; i < length; i++) {\r\n        if (select[i][0] === '-') {\r\n          queryOptions.select[select[i].substring(1)] = 0\r\n        } else {\r\n          queryOptions.select[select[i]] = 1\r\n        }\r\n      }\r\n    }\r\n\r\n    if (queryOptions.populate) {\r\n      if (_.isString(queryOptions.populate)) {\r\n        let populate = queryOptions.populate.split(',')\r\n        queryOptions.populate = []\r\n\r\n        for (let i = 0, length = populate.length; i < length; i++) {\r\n          queryOptions.populate.push({\r\n            path: populate[i]\r\n          })\r\n\r\n          for (let key in queryOptions.select) {\r\n            if (key.indexOf(populate[i] + '.') === 0) {\r\n              if (queryOptions.populate[i].select) {\r\n                queryOptions.populate[i].select += ' '\r\n              } else {\r\n                queryOptions.populate[i].select = ''\r\n              }\r\n\r\n              if (queryOptions.select[key] === 0) {\r\n                queryOptions.populate[i].select += '-'\r\n              }\r\n\r\n              queryOptions.populate[i].select += key.substring(populate[i].length + 1)\r\n              delete queryOptions.select[key]\r\n            }\r\n          }\r\n\r\n          // If other specific fields are selected, add the populated field\r\n          if (queryOptions.select) {\r\n            if (Object.keys(queryOptions.select).length > 0 && !queryOptions.select[populate[i]]) {\r\n              queryOptions.select[populate[i]] = 1\r\n            } else if (Object.keys(queryOptions.select).length === 0) {\r\n              delete queryOptions.select\r\n            }\r\n          }\r\n        }\r\n      } else if (!_.isArray(queryOptions.populate)) {\r\n        queryOptions.populate = [queryOptions.populate]\r\n      }\r\n    }\r\n\r\n    return queryOptions\r\n  }\r\n\r\n  return function (req, res, next) {\r\n    const whitelist = ['distinct', 'limit', 'populate', 'query', 'select', 'skip', 'sort']\r\n\r\n    req._ermQueryOptions = {}\r\n\r\n    for (let key in req.query) {\r\n      if (whitelist.indexOf(key) === -1) {\r\n        continue\r\n      }\r\n\r\n      if (key === 'query') {\r\n        try {\r\n          req._ermQueryOptions[key] = JSON.parse(req.query[key], jsonQueryParser)\r\n        } catch (e) {\r\n          return errorHandler(req, res, next)(new Error(`invalid_json_${key}`))\r\n        }\r\n      } else if (key === 'populate' || key === 'select' || key === 'sort') {\r\n        try {\r\n          req._ermQueryOptions[key] = JSON.parse(req.query[key])\r\n        } catch (e) {\r\n          req._ermQueryOptions[key] = req.query[key]\r\n        }\r\n      } else if (key === 'limit' || key === 'skip') {\r\n        req._ermQueryOptions[key] = parseInt(req.query[key], 10)\r\n      } else {\r\n        req._ermQueryOptions[key] = req.query[key]\r\n      }\r\n    }\r\n\r\n    req._ermQueryOptions = parseQueryOptions(req._ermQueryOptions)\r\n\r\n    next()\r\n  }\r\n}\r\n"]}