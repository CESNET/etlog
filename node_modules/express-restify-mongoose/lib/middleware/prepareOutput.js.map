{"version":3,"sources":["../../src/middleware/prepareOutput.js"],"names":[],"mappings":";;AAAA,IAAM,IAAI,QAAQ,QAAR,CAAV;AACA,IAAM,QAAQ,QAAQ,OAAR,CAAd;;AAEA,OAAO,OAAP,GAAiB,UAAU,OAAV,EAAmB,WAAnB,EAAgC;AAC/C,MAAM,eAAe,QAAQ,iBAAR,EAA2B,OAA3B,CAArB;;AAEA,SAAO,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AAC/B,QAAI,uBAAJ;;AAEA,YAAQ,IAAI,MAAJ,CAAW,WAAX,EAAR;AACE,WAAK,KAAL;AACE,yBAAiB,QAAQ,QAAzB;AACA;AACF,WAAK,MAAL;AACE,YAAI,IAAI,GAAJ,CAAQ,UAAR,KAAuB,GAA3B,EAAgC;AAC9B,2BAAiB,QAAQ,UAAzB;AACD,SAFD,MAEO;AACL,2BAAiB,QAAQ,UAAzB;AACD;AACD;AACF,WAAK,KAAL;AACA,WAAK,OAAL;AACE,yBAAiB,QAAQ,UAAzB;AACA;AACF,WAAK,QAAL;AACE,yBAAiB,QAAQ,UAAzB;AACA;AAjBJ;;AAoBA,UAAM,UAAN,CAAiB,cAAjB,EAAiC,UAAC,UAAD,EAAa,EAAb,EAAoB;AACnD,iBAAW,GAAX,EAAgB,GAAhB,EAAqB,EAArB;AACD,KAFD,EAEG,UAAC,GAAD,EAAS;AACV,UAAI,GAAJ,EAAS;AACP,eAAO,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,EAA6B,GAA7B,CAAP;AACD;;AAED;AACA,UAAI,IAAI,GAAJ,CAAQ,MAAZ,EAAoB;AAClB,YAAI,OAAO;AACT,kBAAQ,IAAI,MADH;AAET,uBAAa,WAFJ;AAGT,oBAAU,IAAI,gBAAJ,GAAuB,IAAI,gBAAJ,CAAqB,QAA5C,GAAuD;AAHxD,SAAX;;AAMA,YAAI,GAAJ,CAAQ,MAAR,GAAiB,QAAQ,MAAR,GAAiB,QAAQ,MAAR,CAAe,YAAf,CAA4B,IAAI,GAAJ,CAAQ,MAApC,EAA4C,IAA5C,CAAjB,GAAqE,IAAI,GAAJ,CAAQ,MAA9F;AACD;;AAED,UAAI,QAAQ,gBAAR,IAA4B,IAAI,GAAJ,CAAQ,UAAxC,EAAoD;AAClD,YAAI,MAAJ,CAAW,EAAE,QAAF,CAAW,QAAQ,gBAAnB,IAAuC,QAAQ,gBAA/C,GAAkE,eAA7E,EAA8F,IAAI,GAAJ,CAAQ,UAAtG;AACD;;AAED,cAAQ,QAAR,CAAiB,GAAjB,EAAsB,GAAtB;;AAEA,UAAI,QAAQ,WAAZ,EAAyB;AACvB,gBAAQ,WAAR,CAAoB,GAApB,EAAyB,GAAzB,EAA8B,IAA9B;AACD;AACF,KA3BD;AA4BD,GAnDD;AAoDD,CAvDD","file":"prepareOutput.js","sourcesContent":["const _ = require('lodash')\r\nconst async = require('async')\r\n\r\nmodule.exports = function (options, excludedMap) {\r\n  const errorHandler = require('../errorHandler')(options)\r\n\r\n  return function (req, res, next) {\r\n    let postMiddleware\r\n\r\n    switch (req.method.toLowerCase()) {\r\n      case 'get':\r\n        postMiddleware = options.postRead\r\n        break\r\n      case 'post':\r\n        if (req.erm.statusCode === 201) {\r\n          postMiddleware = options.postCreate\r\n        } else {\r\n          postMiddleware = options.postUpdate\r\n        }\r\n        break\r\n      case 'put':\r\n      case 'patch':\r\n        postMiddleware = options.postUpdate\r\n        break\r\n      case 'delete':\r\n        postMiddleware = options.postDelete\r\n        break\r\n    }\r\n\r\n    async.eachSeries(postMiddleware, (middleware, cb) => {\r\n      middleware(req, res, cb)\r\n    }, (err) => {\r\n      if (err) {\r\n        return errorHandler(req, res, next)(err)\r\n      }\r\n\r\n      // TODO: this will, but should not, filter /count queries\r\n      if (req.erm.result) {\r\n        let opts = {\r\n          access: req.access,\r\n          excludedMap: excludedMap,\r\n          populate: req._ermQueryOptions ? req._ermQueryOptions.populate : null\r\n        }\r\n\r\n        req.erm.result = options.filter ? options.filter.filterObject(req.erm.result, opts) : req.erm.result\r\n      }\r\n\r\n      if (options.totalCountHeader && req.erm.totalCount) {\r\n        res.header(_.isString(options.totalCountHeader) ? options.totalCountHeader : 'X-Total-Count', req.erm.totalCount)\r\n      }\r\n\r\n      options.outputFn(req, res)\r\n\r\n      if (options.postProcess) {\r\n        options.postProcess(req, res, next)\r\n      }\r\n    })\r\n  }\r\n}\r\n"]}