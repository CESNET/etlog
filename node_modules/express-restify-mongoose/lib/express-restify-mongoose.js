'use strict';

var util = require('util');
var _ = require('lodash');
var Filter = require('./resource_filter');
var customDefaults = null;
var excludedMap = {};

function getDefaults() {
  return _.defaults(customDefaults || {}, {
    prefix: '/api',
    version: '/v1',
    idProperty: '_id',
    findOneAndUpdate: true,
    findOneAndRemove: true,
    lean: true,
    restify: false,
    runValidators: false,
    allowRegex: true,
    private: [],
    protected: []
  });
}

var restify = function restify(app, model) {
  var opts = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

  var options = {};
  _.assign(options, getDefaults(), opts);

  var access = require('./middleware/access');
  var ensureContentType = require('./middleware/ensureContentType')(options);
  var filterAndFindById = require('./middleware/filterAndFindById')(model, options);
  var onError = require('./middleware/onError');
  var outputFn = require('./middleware/outputFn');
  var prepareQuery = require('./middleware/prepareQuery')(options);
  var prepareOutput = require('./middleware/prepareOutput')(options, excludedMap);

  if (!_.isArray(options.private)) {
    throw new Error('"options.private" must be an array of fields');
  }

  if (!_.isArray(options.protected)) {
    throw new Error('"options.protected" must be an array of fields');
  }

  model.schema.eachPath(function (name, path) {
    if (path.options.access) {
      switch (path.options.access.toLowerCase()) {
        case 'private':
          options.private.push(name);
          break;
        case 'protected':
          options.protected.push(name);
          break;
      }
    }
  });

  options.filter = new Filter({
    model: model, excludedMap: excludedMap, filteredKeys: {
      private: options.private,
      protected: options.protected
    }
  });

  excludedMap[model.modelName] = options.filter.filteredKeys;

  if (!_.isArray(options.preMiddleware)) {
    options.preMiddleware = options.preMiddleware ? [options.preMiddleware] : [];
  }

  if (!_.isArray(options.preCreate)) {
    options.preCreate = options.preCreate ? [options.preCreate] : [];
  }

  if (!_.isArray(options.preRead)) {
    options.preRead = options.preRead ? [options.preRead] : [];
  }

  if (!_.isArray(options.preUpdate)) {
    options.preUpdate = options.preUpdate ? [options.preUpdate] : [];
  }

  if (!_.isArray(options.preDelete)) {
    options.preDelete = options.preDelete ? [options.preDelete] : [];
  }

  if (!options.contextFilter) {
    options.contextFilter = function (model, req, done) {
      return done(model);
    };
  }

  if (!_.isArray(options.postCreate)) {
    options.postCreate = options.postCreate ? [options.postCreate] : [];
  }

  if (!_.isArray(options.postRead)) {
    options.postRead = options.postRead ? [options.postRead] : [];
  }

  if (!_.isArray(options.postUpdate)) {
    options.postUpdate = options.postUpdate ? [options.postUpdate] : [];
  }

  if (!_.isArray(options.postDelete)) {
    options.postDelete = options.postDelete ? [options.postDelete] : [];
  }

  if (!options.onError) {
    options.onError = onError(!options.restify);
  }

  if (!options.outputFn) {
    options.outputFn = outputFn(!options.restify);
  }

  options.name = options.name || model.modelName;

  var ops = require('./operations')(model, options, excludedMap);

  var uriItem = '' + options.prefix + options.version + '/' + options.name;
  if (uriItem.indexOf('/:id') === -1) {
    uriItem += '/:id';
  }

  var uriItems = uriItem.replace('/:id', '');
  var uriCount = uriItems + '/count';
  var uriShallow = uriItem + '/shallow';

  if (_.isUndefined(app.delete)) {
    app.delete = app.del;
  }

  app.use(function (req, res, next) {
    req.erm = { model: model };
    next();
  });

  var accessMiddleware = options.access ? access(options) : [];

  app.get(uriItems, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getItems, prepareOutput);
  app.get(uriCount, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getCount, prepareOutput);
  app.get(uriItem, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getItem, prepareOutput);
  app.get(uriShallow, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getShallow, prepareOutput);

  app.post(uriItems, prepareQuery, ensureContentType, options.preMiddleware, options.preCreate, accessMiddleware, ops.createObject, prepareOutput);
  app.post(uriItem, util.deprecate(prepareQuery, 'Warning: in a future major version, the POST method to update resources will be removed. Use PATCH instead.'), ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput);

  app.put(uriItem, util.deprecate(prepareQuery, 'Warning: in a future major version, the PUT method will replace rather than update a resource. Use PATCH instead.'), ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput);
  app.patch(uriItem, prepareQuery, ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput);

  app.delete(uriItems, prepareQuery, options.preMiddleware, options.preDelete, ops.deleteItems, prepareOutput);
  app.delete(uriItem, prepareQuery, options.preMiddleware, options.findOneAndRemove ? [] : filterAndFindById, options.preDelete, ops.deleteItem, prepareOutput);

  return uriItems;
};

module.exports = {
  defaults: function defaults(options) {
    customDefaults = options;
  },
  serve: restify
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHByZXNzLXJlc3RpZnktbW9uZ29vc2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNLE9BQU8sUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNLElBQUksUUFBUSxRQUFSLENBQVY7QUFDQSxJQUFNLFNBQVMsUUFBUSxtQkFBUixDQUFmO0FBQ0EsSUFBSSxpQkFBaUIsSUFBckI7QUFDQSxJQUFJLGNBQWMsRUFBbEI7O0FBRUEsU0FBUyxXQUFULEdBQXdCO0FBQ3RCLFNBQU8sRUFBRSxRQUFGLENBQVcsa0JBQWtCLEVBQTdCLEVBQWlDO0FBQ3RDLFlBQVEsTUFEOEI7QUFFdEMsYUFBUyxLQUY2QjtBQUd0QyxnQkFBWSxLQUgwQjtBQUl0QyxzQkFBa0IsSUFKb0I7QUFLdEMsc0JBQWtCLElBTG9CO0FBTXRDLFVBQU0sSUFOZ0M7QUFPdEMsYUFBUyxLQVA2QjtBQVF0QyxtQkFBZSxLQVJ1QjtBQVN0QyxnQkFBWSxJQVQwQjtBQVV0QyxhQUFTLEVBVjZCO0FBV3RDLGVBQVc7QUFYMkIsR0FBakMsQ0FBUDtBQWFEOztBQUVELElBQU0sVUFBVSxTQUFWLE9BQVUsQ0FBVSxHQUFWLEVBQWUsS0FBZixFQUFpQztBQUFBLE1BQVgsSUFBVyx5REFBSixFQUFJOztBQUMvQyxNQUFJLFVBQVUsRUFBZDtBQUNBLElBQUUsTUFBRixDQUFTLE9BQVQsRUFBa0IsYUFBbEIsRUFBaUMsSUFBakM7O0FBRUEsTUFBTSxTQUFTLFFBQVEscUJBQVIsQ0FBZjtBQUNBLE1BQU0sb0JBQW9CLFFBQVEsZ0NBQVIsRUFBMEMsT0FBMUMsQ0FBMUI7QUFDQSxNQUFNLG9CQUFvQixRQUFRLGdDQUFSLEVBQTBDLEtBQTFDLEVBQWlELE9BQWpELENBQTFCO0FBQ0EsTUFBTSxVQUFVLFFBQVEsc0JBQVIsQ0FBaEI7QUFDQSxNQUFNLFdBQVcsUUFBUSx1QkFBUixDQUFqQjtBQUNBLE1BQU0sZUFBZSxRQUFRLDJCQUFSLEVBQXFDLE9BQXJDLENBQXJCO0FBQ0EsTUFB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QUwsQ0FBZSxZQUFmLEVBQTZCLG1IQUE3QixDQUFqQixFQUFvSyxpQkFBcEssRUFBdUwsUUFBUSxhQUEvTCxFQUE4TSxRQUFRLGdCQUFSLEdBQTJCLEVBQTNCLEdBQWdDLGlCQUE5TyxFQUFpUSxRQUFRLFNBQXpRLEVBQW9SLGdCQUFwUixFQUFzUyxJQUFJLFlBQTFTLEVBQXdULGFBQXhUO0FBQ0EsTUFBSSxLQUFKLENBQVUsT0FBVixFQUFtQixZQUFuQixFQUFpQyxpQkFBakMsRUFBb0QsUUFBUSxhQUE1RCxFQUEyRSxRQUFRLGdCQUFSLEdBQTJCLEVBQTNCLEdBQWdDLGlCQUEzRyxFQUE4SCxRQUFRLFNBQXRJLEVBQWlKLGdCQUFqSixFQUFtSyxJQUFJLFlBQXZLLEVBQXFMLGFBQXJMOztBQUVBLE1BQUksTUFBSixDQUFXLFFBQVgsRUFBcUIsWUFBckIsRUFBbUMsUUFBUSxhQUEzQyxFQUEwRCxRQUFRLFNBQWxFLEVBQTZFLElBQUksV0FBakYsRUFBOEYsYUFBOUY7QUFDQSxNQUFJLE1BQUosQ0FBVyxPQUFYLEVBQW9CLFlBQXBCLEVBQWtDLFFBQVEsYUFBMUMsRUFBeUQsUUFBUSxnQkFBUixHQUEyQixFQUEzQixHQUFnQyxpQkFBekYsRUFBNEcsUUFBUSxTQUFwSCxFQUErSCxJQUFJLFVBQW5JLEVBQStJLGFBQS9JOztBQUVBLFNBQU8sUUFBUDtBQUNELENBaklEOztBQW1JQSxPQUFPLE9BQVAsR0FBaUI7QUFDZixZQUFVLGtCQUFVLE9BQVYsRUFBbUI7QUFDM0IscUJBQWlCLE9BQWpCO0FBQ0QsR0FIYztBQUlmLFNBQU87QUFKUSxDQUFqQiIsImZpbGUiOiJleHByZXNzLXJlc3RpZnktbW9uZ29vc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB1dGlsID0gcmVxdWlyZSgndXRpbCcpXHJcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxyXG5jb25zdCBGaWx0ZXIgPSByZXF1aXJlKCcuL3Jlc291cmNlX2ZpbHRlcicpXHJcbmxldCBjdXN0b21EZWZhdWx0cyA9IG51bGxcclxubGV0IGV4Y2x1ZGVkTWFwID0ge31cclxuXHJcbmZ1bmN0aW9uIGdldERlZmF1bHRzICgpIHtcclxuICByZXR1cm4gXy5kZWZhdWx0cyhjdXN0b21EZWZhdWx0cyB8fCB7fSwge1xyXG4gICAgcHJlZml4OiAnL2FwaScsXHJcbiAgICB2ZXJzaW9uOiAnL3YxJyxcclxuICAgIGlkUHJvcGVydHk6ICdfaWQnLFxyXG4gICAgZmluZE9uZUFuZFVwZGF0ZTogdHJ1ZSxcclxuICAgIGZpbmRPbmVBbmRSZW1vdmU6IHRydWUsXHJcbiAgICBsZWFuOiB0cnVlLFxyXG4gICAgcmVzdGlmeTogZmFsc2UsXHJcbiAgICBydW5WYWxpZGF0b3JzOiBmYWxzZSxcclxuICAgIGFsbG93UmVnZXg6IHRydWUsXHJcbiAgICBwcml2YXRlOiBbXSxcclxuICAgIHByb3RlY3RlZDogW11cclxuICB9KVxyXG59XHJcblxyXG5jb25zdCByZXN0aWZ5ID0gZnVuY3Rpb24gKGFwcCwgbW9kZWwsIG9wdHMgPSB7fSkge1xyXG4gIGxldCBvcHRpb25zID0ge31cclxuICBfLmFzc2lnbihvcHRpb25zLCBnZXREZWZhdWx0cygpLCBvcHRzKVxyXG5cclxuICBjb25zdCBhY2Nlc3MgPSByZXF1aXJlKCcuL21pZGRsZXdhcmUvYWNjZXNzJylcclxuICBjb25zdCBlbnN1cmVDb250ZW50VHlwZSA9IHJlcXVpcmUoJy4vbWlkZGxld2FyZS9lbnN1cmVDb250ZW50VHlwZScpKG9wdGlvbnMpXHJcbiAgY29uc3QgZmlsdGVyQW5kRmluZEJ5SWQgPSByZXF1aXJlKCcuL21pZGRsZXdhcmUvZmlsdGVyQW5kRmluZEJ5SWQnKShtb2RlbCwgb3B0aW9ucylcclxuICBjb25zdCBvbkVycm9yID0gcmVxdWlyZSgnLi9taWRkbGV3YXJlL29uRXJyb3InKVxyXG4gIGNvbnN0IG91dHB1dEZuID0gcmVxdWlyZSgnLi9taWRkbGV3YXJlL291dHB1dEZuJylcclxuICBjb25zdCBwcmVwYXJlUXVlcnkgPSByZXF1aXJlKCcuL21pZGRsZXdhcmUvcHJlcGFyZVF1ZXJ5Jykob3B0aW9ucylcclxuICBjb25zdCBwcmVwYXJlT3V0cHV0ID0gcmVxdWlyZSgnLi9taWRkbGV3YXJlL3ByZXBhcmVPdXRwdXQnKShvcHRpb25zLCBleGNsdWRlZE1hcClcclxuXHJcbiAgaWYgKCFfLmlzQXJyYXkob3B0aW9ucy5wcml2YXRlKSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdcIm9wdGlvbnMucHJpdmF0ZVwiIG11c3QgYmUgYW4gYXJyYXkgb2YgZmllbGRzJylcclxuICB9XHJcblxyXG4gIGlmICghXy5pc0FycmF5KG9wdGlvbnMucHJvdGVjdGVkKSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdcIm9wdGlvbnMucHJvdGVjdGVkXCIgbXVzdCBiZSBhbiBhcnJheSBvZiBmaWVsZHMnKVxyXG4gIH1cclxuXHJcbiAgbW9kZWwuc2NoZW1hLmVhY2hQYXRoKChuYW1lLCBwYXRoKSA9PiB7XHJcbiAgICBpZiAocGF0aC5vcHRpb25zLmFjY2Vzcykge1xyXG4gICAgICBzd2l0Y2ggKHBhdGgub3B0aW9ucy5hY2Nlc3MudG9Mb3dlckNhc2UoKSkge1xyXG4gICAgICAgIGNhc2UgJ3ByaXZhdGUnOlxyXG4gICAgICAgICAgb3B0aW9ucy5wcml2YXRlLnB1c2gobmFtZSlcclxuICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgY2FzZSAncHJvdGVjdGVkJzpcclxuICAgICAgICAgIG9wdGlvbnMucHJvdGVjdGVkLnB1c2gobmFtZSlcclxuICAgICAgICAgIGJyZWFrXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9KVxyXG5cclxuICBvcHRpb25zLmZpbHRlciA9IG5ldyBGaWx0ZXIoe1xyXG4gICAgbW9kZWwsIGV4Y2x1ZGVkTWFwLCBmaWx0ZXJlZEtleXM6IHtcclxuICAgICAgcHJpdmF0ZTogb3B0aW9ucy5wcml2YXRlLFxyXG4gICAgICBwcm90ZWN0ZWQ6IG9wdGlvbnMucHJvdGVjdGVkXHJcbiAgICB9XHJcbiAgfSlcclxuXHJcbiAgZXhjbHVkZWRNYXBbbW9kZWwubW9kZWxOYW1lXSA9IG9wdGlvbnMuZmlsdGVyLmZpbHRlcmVkS2V5c1xyXG5cclxuICBpZiAoIV8uaXNBcnJheShvcHRpb25zLnByZU1pZGRsZXdhcmUpKSB7XHJcbiAgICBvcHRpb25zLnByZU1pZGRsZXdhcmUgPSBvcHRpb25zLnByZU1pZGRsZXdhcmUgPyBbb3B0aW9ucy5wcmVNaWRkbGV3YXJlXSA6IFtdXHJcbiAgfVxyXG5cclxuICBpZiAoIV8uaXNBcnJheShvcHRpb25zLnByZUNyZWF0ZSkpIHtcclxuICAgIG9wdGlvbnMucHJlQ3JlYXRlID0gb3B0aW9ucy5wcmVDcmVhdGUgPyBbb3B0aW9ucy5wcmVDcmVhdGVdIDogW11cclxuICB9XHJcblxyXG4gIGlmICghXy5pc0FycmF5KG9wdGlvbnMucHJlUmVhZCkpIHtcclxuICAgIG9wdGlvbnMucHJlUmVhZCA9IG9wdGlvbnMucHJlUmVhZCA/IFtvcHRpb25zLnByZVJlYWRdIDogW11cclxuICB9XHJcblxyXG4gIGlmICghXy5pc0FycmF5KG9wdGlvbnMucHJlVXBkYXRlKSkge1xyXG4gICAgb3B0aW9ucy5wcmVVcGRhdGUgPSBvcHRpb25zLnByZVVwZGF0ZSA/IFtvcHRpb25zLnByZVVwZGF0ZV0gOiBbXVxyXG4gIH1cclxuXHJcbiAgaWYgKCFfLmlzQXJyYXkob3B0aW9ucy5wcmVEZWxldGUpKSB7XHJcbiAgICBvcHRpb25zLnByZURlbGV0ZSA9IG9wdGlvbnMucHJlRGVsZXRlID8gW29wdGlvbnMucHJlRGVsZXRlXSA6IFtdXHJcbiAgfVxyXG5cclxuICBpZiAoIW9wdGlvbnMuY29udGV4dEZpbHRlcikge1xyXG4gICAgb3B0aW9ucy5jb250ZXh0RmlsdGVyID0gKG1vZGVsLCByZXEsIGRvbmUpID0+IGRvbmUobW9kZWwpXHJcbiAgfVxyXG5cclxuICBpZiAoIV8uaXNBcnJheShvcHRpb25zLnBvc3RDcmVhdGUpKSB7XHJcbiAgICBvcHRpb25zLnBvc3RDcmVhdGUgPSBvcHRpb25zLnBvc3RDcmVhdGUgPyBbb3B0aW9ucy5wb3N0Q3JlYXRlXSA6IFtdXHJcbiAgfVxyXG5cclxuICBpZiAoIV8uaXNBcnJheShvcHRpb25zLnBvc3RSZWFkKSkge1xyXG4gICAgb3B0aW9ucy5wb3N0UmVhZCA9IG9wdGlvbnMucG9zdFJlYWQgPyBbb3B0aW9ucy5wb3N0UmVhZF0gOiBbXVxyXG4gIH1cclxuXHJcbiAgaWYgKCFfLmlzQXJyYXkob3B0aW9ucy5wb3N0VXBkYXRlKSkge1xyXG4gICAgb3B0aW9ucy5wb3N0VXBkYXRlID0gb3B0aW9ucy5wb3N0VXBkYXRlID8gW29wdGlvbnMucG9zdFVwZGF0ZV0gOiBbXVxyXG4gIH1cclxuXHJcbiAgaWYgKCFfLmlzQXJyYXkob3B0aW9ucy5wb3N0RGVsZXRlKSkge1xyXG4gICAgb3B0aW9ucy5wb3N0RGVsZXRlID0gb3B0aW9ucy5wb3N0RGVsZXRlID8gW29wdGlvbnMucG9zdERlbGV0ZV0gOiBbXVxyXG4gIH1cclxuXHJcbiAgaWYgKCFvcHRpb25zLm9uRXJyb3IpIHtcclxuICAgIG9wdGlvbnMub25FcnJvciA9IG9uRXJyb3IoIW9wdGlvbnMucmVzdGlmeSlcclxuICB9XHJcblxyXG4gIGlmICghb3B0aW9ucy5vdXRwdXRGbikge1xyXG4gICAgb3B0aW9ucy5vdXRwdXRGbiA9IG91dHB1dEZuKCFvcHRpb25zLnJlc3RpZnkpXHJcbiAgfVxyXG5cclxuICBvcHRpb25zLm5hbWUgPSBvcHRpb25zLm5hbWUgfHwgbW9kZWwubW9kZWxOYW1lXHJcblxyXG4gIGNvbnN0IG9wcyA9IHJlcXVpcmUoJy4vb3BlcmF0aW9ucycpKG1vZGVsLCBvcHRpb25zLCBleGNsdWRlZE1hcClcclxuXHJcbiAgbGV0IHVyaUl0ZW0gPSBgJHtvcHRpb25zLnByZWZpeH0ke29wdGlvbnMudmVyc2lvbn0vJHtvcHRpb25zLm5hbWV9YFxyXG4gIGlmICh1cmlJdGVtLmluZGV4T2YoJy86aWQnKSA9PT0gLTEpIHtcclxuICAgIHVyaUl0ZW0gKz0gJy86aWQnXHJcbiAgfVxyXG5cclxuICBjb25zdCB1cmlJdGVtcyA9IHVyaUl0ZW0ucmVwbGFjZSgnLzppZCcsICcnKVxyXG4gIGNvbnN0IHVyaUNvdW50ID0gdXJpSXRlbXMgKyAnL2NvdW50J1xyXG4gIGNvbnN0IHVyaVNoYWxsb3cgPSB1cmlJdGVtICsgJy9zaGFsbG93J1xyXG5cclxuICBpZiAoXy5pc1VuZGVmaW5lZChhcHAuZGVsZXRlKSkge1xyXG4gICAgYXBwLmRlbGV0ZSA9IGFwcC5kZWxcclxuICB9XHJcblxyXG4gIGFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICByZXEuZXJtID0geyBtb2RlbCB9XHJcbiAgICBuZXh0KClcclxuICB9KVxyXG5cclxuICBjb25zdCBhY2Nlc3NNaWRkbGV3YXJlID0gb3B0aW9ucy5hY2Nlc3MgPyBhY2Nlc3Mob3B0aW9ucykgOiBbXVxyXG5cclxuICBhcHAuZ2V0KHVyaUl0ZW1zLCBwcmVwYXJlUXVlcnksIG9wdGlvbnMucHJlTWlkZGxld2FyZSwgb3B0aW9ucy5wcmVSZWFkLCBhY2Nlc3NNaWRkbGV3YXJlLCBvcHMuZ2V0SXRlbXMsIHByZXBhcmVPdXRwdXQpXHJcbiAgYXBwLmdldCh1cmlDb3VudCwgcHJlcGFyZVF1ZXJ5LCBvcHRpb25zLnByZU1pZGRsZXdhcmUsIG9wdGlvbnMucHJlUmVhZCwgYWNjZXNzTWlkZGxld2FyZSwgb3BzLmdldENvdW50LCBwcmVwYXJlT3V0cHV0KVxyXG4gIGFwcC5nZXQodXJpSXRlbSwgcHJlcGFyZVF1ZXJ5LCBvcHRpb25zLnByZU1pZGRsZXdhcmUsIG9wdGlvbnMucHJlUmVhZCwgYWNjZXNzTWlkZGxld2FyZSwgb3BzLmdldEl0ZW0sIHByZXBhcmVPdXRwdXQpXHJcbiAgYXBwLmdldCh1cmlTaGFsbG93LCBwcmVwYXJlUXVlcnksIG9wdGlvbnMucHJlTWlkZGxld2FyZSwgb3B0aW9ucy5wcmVSZWFkLCBhY2Nlc3NNaWRkbGV3YXJlLCBvcHMuZ2V0U2hhbGxvdywgcHJlcGFyZU91dHB1dClcclxuXHJcbiAgYXBwLnBvc3QodXJpSXRlbXMsIHByZXBhcmVRdWVyeSwgZW5zdXJlQ29udGVudFR5cGUsIG9wdGlvbnMucHJlTWlkZGxld2FyZSwgb3B0aW9ucy5wcmVDcmVhdGUsIGFjY2Vzc01pZGRsZXdhcmUsIG9wcy5jcmVhdGVPYmplY3QsIHByZXBhcmVPdXRwdXQpXHJcbiAgYXBwLnBvc3QodXJpSXRlbSwgdXRpbC5kZXByZWNhdGUocHJlcGFyZVF1ZXJ5LCAnV2FybmluZzogaW4gYSBmdXR1cmUgbWFqb3IgdmVyc2lvbiwgdGhlIFBPU1QgbWV0aG9kIHRvIHVwZGF0ZSByZXNvdXJjZXMgd2lsbCBiZSByZW1vdmVkLiBVc2UgUEFUQ0ggaW5zdGVhZC4nKSwgZW5zdXJlQ29udGVudFR5cGUsIG9wdGlvbnMucHJlTWlkZGxld2FyZSwgb3B0aW9ucy5maW5kT25lQW5kVXBkYXRlID8gW10gOiBmaWx0ZXJBbmRGaW5kQnlJZCwgb3B0aW9ucy5wcmVVcGRhdGUsIGFjY2Vzc01pZGRsZXdhcmUsIG9wcy5tb2RpZnlPYmplY3QsIHByZXBhcmVPdXRwdXQpXHJcblxyXG4gIGFwcC5wdXQodXJpSXRlbSwgdXRpbC5kZXByZWNhdGUocHJlcGFyZVF1ZXJ5LCAnV2FybmluZzogaW4gYSBmdXR1cmUgbWFqb3IgdmVyc2lvbiwgdGhlIFBVVCBtZXRob2Qgd2lsbCByZXBsYWNlIHJhdGhlciB0aGFuIHVwZGF0ZSBhIHJlc291cmNlLiBVc2UgUEFUQ0ggaW5zdGVhZC4nKSwgZW5zdXJlQ29udGVudFR5cGUsIG9wdGlvbnMucHJlTWlkZGxld2FyZSwgb3B0aW9ucy5maW5kT25lQW5kVXBkYXRlID8gW10gOiBmaWx0ZXJBbmRGaW5kQnlJZCwgb3B0aW9ucy5wcmVVcGRhdGUsIGFjY2Vzc01pZGRsZXdhcmUsIG9wcy5tb2RpZnlPYmplY3QsIHByZXBhcmVPdXRwdXQpXHJcbiAgYXBwLnBhdGNoKHVyaUl0ZW0sIHByZXBhcmVRdWVyeSwgZW5zdXJlQ29udGVudFR5cGUsIG9wdGlvbnMucHJlTWlkZGxld2FyZSwgb3B0aW9ucy5maW5kT25lQW5kVXBkYXRlID8gW10gOiBmaWx0ZXJBbmRGaW5kQnlJZCwgb3B0aW9ucy5wcmVVcGRhdGUsIGFjY2Vzc01pZGRsZXdhcmUsIG9wcy5tb2RpZnlPYmplY3QsIHByZXBhcmVPdXRwdXQpXHJcblxyXG4gIGFwcC5kZWxldGUodXJpSXRlbXMsIHByZXBhcmVRdWVyeSwgb3B0aW9ucy5wcmVNaWRkbGV3YXJlLCBvcHRpb25zLnByZURlbGV0ZSwgb3BzLmRlbGV0ZUl0ZW1zLCBwcmVwYXJlT3V0cHV0KVxyXG4gIGFwcC5kZWxldGUodXJpSXRlbSwgcHJlcGFyZVF1ZXJ5LCBvcHRpb25zLnByZU1pZGRsZXdhcmUsIG9wdGlvbnMuZmluZE9uZUFuZFJlbW92ZSA/IFtdIDogZmlsdGVyQW5kRmluZEJ5SWQsIG9wdGlvbnMucHJlRGVsZXRlLCBvcHMuZGVsZXRlSXRlbSwgcHJlcGFyZU91dHB1dClcclxuXHJcbiAgcmV0dXJuIHVyaUl0ZW1zXHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGRlZmF1bHRzOiBmdW5jdGlvbiAob3B0aW9ucykge1xyXG4gICAgY3VzdG9tRGVmYXVsdHMgPSBvcHRpb25zXHJcbiAgfSxcclxuICBzZXJ2ZTogcmVzdGlmeVxyXG59XHJcbiJdfQ==
//# sourceMappingURL=express-restify-mongoose.js.map