{"version":3,"sources":["../src/express-restify-mongoose.js"],"names":[],"mappings":"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","file":"express-restify-mongoose.js","sourcesContent":["const util = require('util')\r\nconst _ = require('lodash')\r\nconst Filter = require('./resource_filter')\r\nlet customDefaults = null\r\nlet excludedMap = {}\r\n\r\nfunction getDefaults () {\r\n  return _.defaults(customDefaults || {}, {\r\n    prefix: '/api',\r\n    version: '/v1',\r\n    idProperty: '_id',\r\n    findOneAndUpdate: true,\r\n    findOneAndRemove: true,\r\n    lean: true,\r\n    restify: false,\r\n    runValidators: false,\r\n    allowRegex: true,\r\n    private: [],\r\n    protected: []\r\n  })\r\n}\r\n\r\nconst restify = function (app, model, opts = {}) {\r\n  let options = {}\r\n  _.assign(options, getDefaults(), opts)\r\n\r\n  const access = require('./middleware/access')\r\n  const ensureContentType = require('./middleware/ensureContentType')(options)\r\n  const filterAndFindById = require('./middleware/filterAndFindById')(model, options)\r\n  const onError = require('./middleware/onError')\r\n  const outputFn = require('./middleware/outputFn')\r\n  const prepareQuery = require('./middleware/prepareQuery')(options)\r\n  const prepareOutput = require('./middleware/prepareOutput')(options, excludedMap)\r\n\r\n  if (!_.isArray(options.private)) {\r\n    throw new Error('\"options.private\" must be an array of fields')\r\n  }\r\n\r\n  if (!_.isArray(options.protected)) {\r\n    throw new Error('\"options.protected\" must be an array of fields')\r\n  }\r\n\r\n  model.schema.eachPath((name, path) => {\r\n    if (path.options.access) {\r\n      switch (path.options.access.toLowerCase()) {\r\n        case 'private':\r\n          options.private.push(name)\r\n          break\r\n        case 'protected':\r\n          options.protected.push(name)\r\n          break\r\n      }\r\n    }\r\n  })\r\n\r\n  options.filter = new Filter({\r\n    model, excludedMap, filteredKeys: {\r\n      private: options.private,\r\n      protected: options.protected\r\n    }\r\n  })\r\n\r\n  excludedMap[model.modelName] = options.filter.filteredKeys\r\n\r\n  if (!_.isArray(options.preMiddleware)) {\r\n    options.preMiddleware = options.preMiddleware ? [options.preMiddleware] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preCreate)) {\r\n    options.preCreate = options.preCreate ? [options.preCreate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preRead)) {\r\n    options.preRead = options.preRead ? [options.preRead] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preUpdate)) {\r\n    options.preUpdate = options.preUpdate ? [options.preUpdate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preDelete)) {\r\n    options.preDelete = options.preDelete ? [options.preDelete] : []\r\n  }\r\n\r\n  if (!options.contextFilter) {\r\n    options.contextFilter = (model, req, done) => done(model)\r\n  }\r\n\r\n  if (!_.isArray(options.postCreate)) {\r\n    options.postCreate = options.postCreate ? [options.postCreate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.postRead)) {\r\n    options.postRead = options.postRead ? [options.postRead] : []\r\n  }\r\n\r\n  if (!_.isArray(options.postUpdate)) {\r\n    options.postUpdate = options.postUpdate ? [options.postUpdate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.postDelete)) {\r\n    options.postDelete = options.postDelete ? [options.postDelete] : []\r\n  }\r\n\r\n  if (!options.onError) {\r\n    options.onError = onError(!options.restify)\r\n  }\r\n\r\n  if (!options.outputFn) {\r\n    options.outputFn = outputFn(!options.restify)\r\n  }\r\n\r\n  options.name = options.name || model.modelName\r\n\r\n  const ops = require('./operations')(model, options, excludedMap)\r\n\r\n  let uriItem = `${options.prefix}${options.version}/${options.name}`\r\n  if (uriItem.indexOf('/:id') === -1) {\r\n    uriItem += '/:id'\r\n  }\r\n\r\n  const uriItems = uriItem.replace('/:id', '')\r\n  const uriCount = uriItems + '/count'\r\n  const uriShallow = uriItem + '/shallow'\r\n\r\n  if (_.isUndefined(app.delete)) {\r\n    app.delete = app.del\r\n  }\r\n\r\n  app.use((req, res, next) => {\r\n    req.erm = { model }\r\n    next()\r\n  })\r\n\r\n  const accessMiddleware = options.access ? access(options) : []\r\n\r\n  app.get(uriItems, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getItems, prepareOutput)\r\n  app.get(uriCount, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getCount, prepareOutput)\r\n  app.get(uriItem, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getItem, prepareOutput)\r\n  app.get(uriShallow, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getShallow, prepareOutput)\r\n\r\n  app.post(uriItems, prepareQuery, ensureContentType, options.preMiddleware, options.preCreate, accessMiddleware, ops.createObject, prepareOutput)\r\n  app.post(uriItem, util.deprecate(prepareQuery, 'Warning: in a future major version, the POST method to update resources will be removed. Use PATCH instead.'), ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput)\r\n\r\n  app.put(uriItem, util.deprecate(prepareQuery, 'Warning: in a future major version, the PUT method will replace rather than update a resource. Use PATCH instead.'), ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput)\r\n  app.patch(uriItem, prepareQuery, ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput)\r\n\r\n  app.delete(uriItems, prepareQuery, options.preMiddleware, options.preDelete, ops.deleteItems, prepareOutput)\r\n  app.delete(uriItem, prepareQuery, options.preMiddleware, options.findOneAndRemove ? [] : filterAndFindById, options.preDelete, ops.deleteItem, prepareOutput)\r\n\r\n  return uriItems\r\n}\r\n\r\nmodule.exports = {\r\n  defaults: function (options) {\r\n    customDefaults = options\r\n  },\r\n  serve: restify\r\n}\r\n"]}