{"version":3,"sources":["../src/operations.js"],"names":[],"mappings":";;;;;;AAAA,IAAM,IAAI,QAAQ,QAAR,CAAV;AACA,IAAM,OAAO,QAAQ,MAAR,CAAb;AACA,IAAM,WAAW,QAAQ,UAAR,CAAjB;;AAEA,OAAO,OAAP,GAAiB,UAAU,KAAV,EAAiB,OAAjB,EAA0B,WAA1B,EAAuC;AACtD,MAAM,aAAa,QAAQ,cAAR,EAAwB,OAAxB,CAAnB;AACA,MAAM,eAAe,QAAQ,gBAAR,EAA0B,OAA1B,CAArB;;AAEA,WAAS,QAAT,CAAmB,eAAnB,EAAoC,EAApC,EAAwC;AACtC,WAAO,gBAAgB,OAAhB,GAA0B,GAA1B,qBACJ,QAAQ,UADJ,EACiB,EADjB,EAAP;AAGD;;AAED,WAAS,kBAAT,CAA6B,GAA7B,EAAkC;AAChC,WAAO,QAAQ,MAAR,CAAe,UAAf,CAA0B,IAAI,gBAAJ,CAAqB,UAArB,CAA1B,EAA4D;AACjE,cAAQ,IAAI,MADqD;AAEjE,mBAAa;AAFoD,KAA5D,CAAP;AAID;;AAED,WAAS,QAAT,CAAmB,GAAnB,EAAwB,GAAxB,EAA6B,IAA7B,EAAmC;AACjC,QAAI,mBAAmB,GAAnB,CAAJ,EAA6B;AAC3B,UAAI,GAAJ,CAAQ,MAAR,GAAiB,EAAjB;AACA,UAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;AACA,aAAO,MAAP;AACD;;AAED,YAAQ,aAAR,CAAsB,KAAtB,EAA6B,GAA7B,EAAkC,UAAC,eAAD,EAAqB;AACrD,iBAAW,gBAAgB,IAAhB,EAAX,EAAmC,IAAI,gBAAvC,EAAyD,IAAzD,CAA8D,UAAC,KAAD,EAAW;AACvE,YAAI,GAAJ,CAAQ,MAAR,GAAiB,KAAjB;AACA,YAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;;AAEA,YAAI,QAAQ,gBAAR,IAA4B,CAAC,IAAI,gBAAJ,CAAqB,UAArB,CAAjC,EAAmE;AACjE,qBAAW,gBAAgB,KAAhB,EAAX,EAAoC,EAAE,MAAF,CAAS,IAAI,gBAAb,EAA+B;AACjE,kBAAM,CAD2D;AAEjE,mBAAO;AAF0D,WAA/B,CAApC,EAGI,IAHJ,CAGS,UAAC,KAAD,EAAW;AAClB,gBAAI,GAAJ,CAAQ,UAAR,GAAqB,KAArB;AACA;AACD,WAND,EAMG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CANH;AAOD,SARD,MAQO;AACL;AACD;AACF,OAfD,EAeG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CAfH;AAgBD,KAjBD;AAkBD;;AAED,WAAS,QAAT,CAAmB,GAAnB,EAAwB,GAAxB,EAA6B,IAA7B,EAAmC;AACjC,YAAQ,aAAR,CAAsB,KAAtB,EAA6B,GAA7B,EAAkC,UAAC,eAAD,EAAqB;AACrD,iBAAW,gBAAgB,KAAhB,EAAX,EAAoC,IAAI,gBAAxC,EAA0D,IAA1D,CAA+D,UAAC,KAAD,EAAW;AACxE,YAAI,GAAJ,CAAQ,MAAR,GAAiB,EAAE,OAAO,KAAT,EAAjB;AACA,YAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;;AAEA;AACD,OALD,EAKG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CALH;AAMD,KAPD;AAQD;;AAED,WAAS,UAAT,CAAqB,GAArB,EAA0B,GAA1B,EAA+B,IAA/B,EAAqC;AACnC,YAAQ,aAAR,CAAsB,KAAtB,EAA6B,GAA7B,EAAkC,UAAC,eAAD,EAAqB;AACrD,iBAAW,SAAS,eAAT,EAA0B,IAAI,MAAJ,CAAW,EAArC,CAAX,EAAqD,IAAI,gBAAzD,EAA2E,IAA3E,CAAgF,UAAC,IAAD,EAAU;AACxF,YAAI,CAAC,IAAL,EAAW;AACT,iBAAO,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,EAA6B,IAAI,KAAJ,CAAU,KAAK,YAAL,CAAkB,GAAlB,CAAV,CAA7B,CAAP;AACD;;AAED,aAAK,IAAI,IAAT,IAAiB,IAAjB,EAAuB;AACrB,eAAK,IAAL,IAAa,QAAO,KAAK,IAAL,CAAP,MAAsB,QAAtB,IAAkC,SAAS,KAA3C,GAAmD,IAAnD,GAA0D,KAAK,IAAL,CAAvE;AACD;;AAED,YAAI,GAAJ,CAAQ,MAAR,GAAiB,IAAjB;AACA,YAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;;AAEA;AACD,OAbD,EAaG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CAbH;AAcD,KAfD;AAgBD;;AAED,WAAS,WAAT,CAAsB,GAAtB,EAA2B,GAA3B,EAAgC,IAAhC,EAAsC;AACpC,YAAQ,aAAR,CAAsB,KAAtB,EAA6B,GAA7B,EAAkC,UAAC,eAAD,EAAqB;AACrD,iBAAW,gBAAgB,MAAhB,EAAX,EAAqC,IAAI,gBAAzC,EAA2D,IAA3D,CAAgE,YAAM;AACpE,YAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;;AAEA;AACD,OAJD,EAIG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CAJH;AAKD,KAND;AAOD;;AAED,WAAS,OAAT,CAAkB,GAAlB,EAAuB,GAAvB,EAA4B,IAA5B,EAAkC;AAChC,QAAI,mBAAmB,GAAnB,CAAJ,EAA6B;AAC3B,UAAI,GAAJ,CAAQ,MAAR,GAAiB,EAAjB;AACA,UAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;AACA,aAAO,MAAP;AACD;;AAED,YAAQ,aAAR,CAAsB,KAAtB,EAA6B,GAA7B,EAAkC,UAAC,eAAD,EAAqB;AACrD,iBAAW,SAAS,eAAT,EAA0B,IAAI,MAAJ,CAAW,EAArC,CAAX,EAAqD,IAAI,gBAAzD,EAA2E,IAA3E,CAAgF,UAAC,IAAD,EAAU;AACxF,YAAI,CAAC,IAAL,EAAW;AACT,iBAAO,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,EAA6B,IAAI,KAAJ,CAAU,KAAK,YAAL,CAAkB,GAAlB,CAAV,CAA7B,CAAP;AACD;;AAED,YAAI,GAAJ,CAAQ,MAAR,GAAiB,IAAjB;AACA,YAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;;AAEA;AACD,OATD,EASG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CATH;AAUD,KAXD;AAYD;;AAED,WAAS,UAAT,CAAqB,GAArB,EAA0B,GAA1B,EAA+B,IAA/B,EAAqC;AACnC,QAAI,QAAQ,gBAAZ,EAA8B;AAC5B,cAAQ,aAAR,CAAsB,KAAtB,EAA6B,GAA7B,EAAkC,UAAC,eAAD,EAAqB;AACrD,iBAAS,eAAT,EAA0B,IAAI,MAAJ,CAAW,EAArC,EAAyC,gBAAzC,GAA4D,IAA5D,CAAiE,UAAC,IAAD,EAAU;AACzE,cAAI,CAAC,IAAL,EAAW;AACT,mBAAO,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,EAA6B,IAAI,KAAJ,CAAU,KAAK,YAAL,CAAkB,GAAlB,CAAV,CAA7B,CAAP;AACD;;AAED,cAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;;AAEA;AACD,SARD,EAQG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CARH;AASD,OAVD;AAWD,KAZD,MAYO;AACL,UAAI,GAAJ,CAAQ,QAAR,CAAiB,MAAjB,GAA0B,IAA1B,CAA+B,YAAM;AACnC,YAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;;AAEA;AACD,OAJD,EAIG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CAJH;AAKD;AACF;;AAED,WAAS,YAAT,CAAuB,GAAvB,EAA4B,GAA5B,EAAiC,IAAjC,EAAuC;AACrC,QAAI,IAAJ,GAAW,QAAQ,MAAR,CAAe,YAAf,CAA4B,IAAI,IAAJ,IAAY,EAAxC,EAA4C;AACrD,cAAQ,IAAI,MADyC;AAErD,gBAAU,IAAI,gBAAJ,CAAqB;AAFsB,KAA5C,CAAX;;AAKA,QAAI,MAAM,MAAN,CAAa,OAAb,CAAqB,GAAzB,EAA8B;AAC5B,aAAO,IAAI,IAAJ,CAAS,GAAhB;AACD;;AAED,QAAI,MAAM,MAAN,CAAa,OAAb,CAAqB,UAAzB,EAAqC;AACnC,aAAO,IAAI,IAAJ,CAAS,MAAM,MAAN,CAAa,OAAb,CAAqB,UAA9B,CAAP;AACD;;AAED,UAAM,MAAN,CAAa,IAAI,IAAjB,EAAuB,IAAvB,CAA4B,UAAC,IAAD;AAAA,aAAU,MAAM,QAAN,CAAe,IAAf,EAAqB,IAAI,gBAAJ,CAAqB,QAArB,IAAiC,EAAtD,CAAV;AAAA,KAA5B,EAAiG,IAAjG,CAAsG,UAAC,IAAD,EAAU;AAC9G,UAAI,GAAJ,CAAQ,MAAR,GAAiB,IAAjB;AACA,UAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;;AAEA;AACD,KALD,EAKG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CALH;AAMD;;AAED,WAAS,YAAT,CAAuB,GAAvB,EAA4B,GAA5B,EAAiC,IAAjC,EAAuC;AACrC,QAAI,IAAJ,GAAW,QAAQ,MAAR,CAAe,YAAf,CAA4B,IAAI,IAAJ,IAAY,EAAxC,EAA4C;AACrD,cAAQ,IAAI,MADyC;AAErD,gBAAU,IAAI,gBAAJ,CAAqB;AAFsB,KAA5C,CAAX;;AAKA,WAAO,IAAI,IAAJ,CAAS,GAAhB;;AAEA,QAAI,MAAM,MAAN,CAAa,OAAb,CAAqB,UAAzB,EAAqC;AACnC,aAAO,IAAI,IAAJ,CAAS,MAAM,MAAN,CAAa,OAAb,CAAqB,UAA9B,CAAP;AACD;;AAED,aAAS,UAAT,CAAqB,GAArB,EAA0B;AACxB,UAAI,MAAM,EAAV;;AAEA,WAAK,IAAI,GAAT,IAAgB,GAAhB,EAAqB;AACnB,YAAM,OAAO,MAAM,MAAN,CAAa,IAAb,CAAkB,GAAlB,CAAb;;AAEA,YAAI,QAAQ,KAAK,MAAb,IAAuB,KAAK,MAAL,CAAY,QAAZ,KAAyB,UAApD,EAAgE;AAC9D,cAAI,EAAE,OAAF,CAAU,IAAI,GAAJ,CAAV,CAAJ,EAAyB;AACvB,iBAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,IAAI,GAAJ,EAAS,MAA7B,EAAqC,EAAE,CAAvC,EAA0C;AACxC,kBAAI,QAAO,IAAI,GAAJ,EAAS,CAAT,CAAP,MAAuB,QAA3B,EAAqC;AACnC,oBAAI,GAAJ,IAAW,IAAI,GAAJ,KAAY,EAAvB;AACA,oBAAI,GAAJ,EAAS,CAAT,IAAc,IAAI,GAAJ,EAAS,CAAT,EAAY,GAA1B;AACD;AACF;AACF,WAPD,MAOO,IAAI,EAAE,aAAF,CAAgB,IAAI,GAAJ,CAAhB,CAAJ,EAA+B;AACpC,gBAAI,GAAJ,IAAW,IAAI,GAAJ,EAAS,GAApB;AACD;AACF,SAXD,MAWO,IAAI,EAAE,aAAF,CAAgB,IAAI,GAAJ,CAAhB,CAAJ,EAA+B;AACpC,cAAI,QAAQ,KAAK,QAAL,KAAkB,UAA9B,EAA0C;AACxC,gBAAI,GAAJ,IAAW,IAAI,GAAJ,EAAS,GAApB;AACD,WAFD,MAEO;AACL,gBAAI,GAAJ,IAAW,WAAW,IAAI,GAAJ,CAAX,CAAX;AACD;AACF;;AAED,YAAI,EAAE,WAAF,CAAc,IAAI,GAAJ,CAAd,CAAJ,EAA6B;AAC3B,cAAI,GAAJ,IAAW,IAAI,GAAJ,CAAX;AACD;AACF;;AAED,aAAO,GAAP;AACD;;AAED,QAAM,YAAY,SAAS,WAAW,IAAI,IAAf,CAAT,CAAlB;;AAEA,QAAI,QAAQ,gBAAZ,EAA8B;AAC5B,cAAQ,aAAR,CAAsB,KAAtB,EAA6B,GAA7B,EAAkC,UAAC,eAAD,EAAqB;AACrD,iBAAS,eAAT,EAA0B,IAAI,MAAJ,CAAW,EAArC,EAAyC,gBAAzC,CAA0D,EAA1D,EAA8D;AAC5D,gBAAM;AADsD,SAA9D,EAEG;AACD,eAAK,IADJ;AAED,yBAAe,QAAQ;AAFtB,SAFH,EAKG,IALH,GAKU,IALV,CAKe,UAAC,IAAD;AAAA,iBAAU,MAAM,QAAN,CAAe,IAAf,EAAqB,IAAI,gBAAJ,CAAqB,QAArB,IAAiC,EAAtD,CAAV;AAAA,SALf,EAKoF,IALpF,CAKyF,UAAC,IAAD,EAAU;AACjG,cAAI,CAAC,IAAL,EAAW;AACT,mBAAO,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,EAA6B,IAAI,KAAJ,CAAU,KAAK,YAAL,CAAkB,GAAlB,CAAV,CAA7B,CAAP;AACD;;AAED,cAAI,GAAJ,CAAQ,MAAR,GAAiB,IAAjB;AACA,cAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;;AAEA;AACD,SAdD,EAcG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CAdH;AAeD,OAhBD;AAiBD,KAlBD,MAkBO;AACL,WAAK,IAAI,GAAT,IAAgB,SAAhB,EAA2B;AACzB,YAAI,GAAJ,CAAQ,QAAR,CAAiB,GAAjB,CAAqB,GAArB,EAA0B,UAAU,GAAV,CAA1B;AACD;;AAED,UAAI,GAAJ,CAAQ,QAAR,CAAiB,IAAjB,GAAwB,IAAxB,CAA6B,UAAC,IAAD;AAAA,eAAU,MAAM,QAAN,CAAe,IAAf,EAAqB,IAAI,gBAAJ,CAAqB,QAArB,IAAiC,EAAtD,CAAV;AAAA,OAA7B,EAAkG,IAAlG,CAAuG,UAAC,IAAD,EAAU;AAC/G,YAAI,GAAJ,CAAQ,MAAR,GAAiB,IAAjB;AACA,YAAI,GAAJ,CAAQ,UAAR,GAAqB,GAArB;;AAEA;AACD,OALD,EAKG,aAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAvB,CALH;AAMD;AACF;;AAED,SAAO,EAAE,kBAAF,EAAY,kBAAZ,EAAsB,gBAAtB,EAA+B,sBAA/B,EAA2C,0BAA3C,EAAyD,0BAAzD,EAAuE,wBAAvE,EAAoF,sBAApF,EAAP;AACD,CArOD","file":"operations.js","sourcesContent":["const _ = require('lodash')\r\nconst http = require('http')\r\nconst moredots = require('moredots')\r\n\r\nmodule.exports = function (model, options, excludedMap) {\r\n  const buildQuery = require('./buildQuery')(options)\r\n  const errorHandler = require('./errorHandler')(options)\r\n\r\n  function findById (filteredContext, id) {\r\n    return filteredContext.findOne().and({\r\n      [options.idProperty]: id\r\n    })\r\n  }\r\n\r\n  function isDistinctExcluded (req) {\r\n    return options.filter.isExcluded(req._ermQueryOptions['distinct'], {\r\n      access: req.access,\r\n      excludedMap: excludedMap\r\n    })\r\n  }\r\n\r\n  function getItems (req, res, next) {\r\n    if (isDistinctExcluded(req)) {\r\n      req.erm.result = []\r\n      req.erm.statusCode = 200\r\n      return next()\r\n    }\r\n\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(filteredContext.find(), req._ermQueryOptions).then((items) => {\r\n        req.erm.result = items\r\n        req.erm.statusCode = 200\r\n\r\n        if (options.totalCountHeader && !req._ermQueryOptions['distinct']) {\r\n          buildQuery(filteredContext.count(), _.assign(req._ermQueryOptions, {\r\n            skip: 0,\r\n            limit: 0\r\n          })).then((count) => {\r\n            req.erm.totalCount = count\r\n            next()\r\n          }, errorHandler(req, res, next))\r\n        } else {\r\n          next()\r\n        }\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function getCount (req, res, next) {\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(filteredContext.count(), req._ermQueryOptions).then((count) => {\r\n        req.erm.result = { count: count }\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function getShallow (req, res, next) {\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(findById(filteredContext, req.params.id), req._ermQueryOptions).then((item) => {\r\n        if (!item) {\r\n          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n        }\r\n\r\n        for (let prop in item) {\r\n          item[prop] = typeof item[prop] === 'object' && prop !== '_id' ? true : item[prop]\r\n        }\r\n\r\n        req.erm.result = item\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function deleteItems (req, res, next) {\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(filteredContext.remove(), req._ermQueryOptions).then(() => {\r\n        req.erm.statusCode = 204\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function getItem (req, res, next) {\r\n    if (isDistinctExcluded(req)) {\r\n      req.erm.result = []\r\n      req.erm.statusCode = 200\r\n      return next()\r\n    }\r\n\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(findById(filteredContext, req.params.id), req._ermQueryOptions).then((item) => {\r\n        if (!item) {\r\n          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n        }\r\n\r\n        req.erm.result = item\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function deleteItem (req, res, next) {\r\n    if (options.findOneAndRemove) {\r\n      options.contextFilter(model, req, (filteredContext) => {\r\n        findById(filteredContext, req.params.id).findOneAndRemove().then((item) => {\r\n          if (!item) {\r\n            return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n          }\r\n\r\n          req.erm.statusCode = 204\r\n\r\n          next()\r\n        }, errorHandler(req, res, next))\r\n      })\r\n    } else {\r\n      req.erm.document.remove().then(() => {\r\n        req.erm.statusCode = 204\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    }\r\n  }\r\n\r\n  function createObject (req, res, next) {\r\n    req.body = options.filter.filterObject(req.body || {}, {\r\n      access: req.access,\r\n      populate: req._ermQueryOptions.populate\r\n    })\r\n\r\n    if (model.schema.options._id) {\r\n      delete req.body._id\r\n    }\r\n\r\n    if (model.schema.options.versionKey) {\r\n      delete req.body[model.schema.options.versionKey]\r\n    }\r\n\r\n    model.create(req.body).then((item) => model.populate(item, req._ermQueryOptions.populate || [])).then((item) => {\r\n      req.erm.result = item\r\n      req.erm.statusCode = 201\r\n\r\n      next()\r\n    }, errorHandler(req, res, next))\r\n  }\r\n\r\n  function modifyObject (req, res, next) {\r\n    req.body = options.filter.filterObject(req.body || {}, {\r\n      access: req.access,\r\n      populate: req._ermQueryOptions.populate\r\n    })\r\n\r\n    delete req.body._id\r\n\r\n    if (model.schema.options.versionKey) {\r\n      delete req.body[model.schema.options.versionKey]\r\n    }\r\n\r\n    function depopulate (src) {\r\n      let dst = {}\r\n\r\n      for (let key in src) {\r\n        const path = model.schema.path(key)\r\n\r\n        if (path && path.caster && path.caster.instance === 'ObjectID') {\r\n          if (_.isArray(src[key])) {\r\n            for (let j = 0; j < src[key].length; ++j) {\r\n              if (typeof src[key][j] === 'object') {\r\n                dst[key] = dst[key] || {}\r\n                dst[key][j] = src[key][j]._id\r\n              }\r\n            }\r\n          } else if (_.isPlainObject(src[key])) {\r\n            dst[key] = src[key]._id\r\n          }\r\n        } else if (_.isPlainObject(src[key])) {\r\n          if (path && path.instance === 'ObjectID') {\r\n            dst[key] = src[key]._id\r\n          } else {\r\n            dst[key] = depopulate(src[key])\r\n          }\r\n        }\r\n\r\n        if (_.isUndefined(dst[key])) {\r\n          dst[key] = src[key]\r\n        }\r\n      }\r\n\r\n      return dst\r\n    }\r\n\r\n    const cleanBody = moredots(depopulate(req.body))\r\n\r\n    if (options.findOneAndUpdate) {\r\n      options.contextFilter(model, req, (filteredContext) => {\r\n        findById(filteredContext, req.params.id).findOneAndUpdate({}, {\r\n          $set: cleanBody\r\n        }, {\r\n          new: true,\r\n          runValidators: options.runValidators\r\n        }).exec().then((item) => model.populate(item, req._ermQueryOptions.populate || [])).then((item) => {\r\n          if (!item) {\r\n            return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n          }\r\n\r\n          req.erm.result = item\r\n          req.erm.statusCode = 200\r\n\r\n          next()\r\n        }, errorHandler(req, res, next))\r\n      })\r\n    } else {\r\n      for (let key in cleanBody) {\r\n        req.erm.document.set(key, cleanBody[key])\r\n      }\r\n\r\n      req.erm.document.save().then((item) => model.populate(item, req._ermQueryOptions.populate || [])).then((item) => {\r\n        req.erm.result = item\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    }\r\n  }\r\n\r\n  return { getItems, getCount, getItem, getShallow, createObject, modifyObject, deleteItems, deleteItem }\r\n}\r\n"]}