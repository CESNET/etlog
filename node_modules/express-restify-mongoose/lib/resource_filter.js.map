{"version":3,"sources":["../src/resource_filter.js"],"names":[],"mappings":"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","file":"resource_filter.js","sourcesContent":["const _ = require('lodash')\r\nconst detective = require('mongoose-detective')\r\nconst weedout = require('weedout')\r\n\r\n/**\r\n * Represents a filter.\r\n * @constructor\r\n * @param {Object} opts - Options\r\n * @param {Object} opts.model - Mongoose model\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @param {Object} opts.filteredKeys {} - Keys to filter for the current model\r\n */\r\nfunction Filter (opts) {\r\n  this.model = opts.model\r\n\r\n  this.filteredKeys = _.isPlainObject(opts.filteredKeys) ? {\r\n    private: opts.filteredKeys.private || [],\r\n    protected: opts.filteredKeys.protected || []\r\n  } : {\r\n    private: [],\r\n    protected: []\r\n  }\r\n\r\n  if (this.model && this.model.discriminators && _.isPlainObject(opts.excludedMap)) {\r\n    for (let modelName in this.model.discriminators) {\r\n      if (opts.excludedMap[modelName]) {\r\n        this.filteredKeys.private = this.filteredKeys.private.concat(opts.excludedMap[modelName].private)\r\n        this.filteredKeys.protected = this.filteredKeys.protected.concat(opts.excludedMap[modelName].protected)\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Gets excluded keys for a given model and access.\r\n * @memberof Filter\r\n * @param {Object} - Options.\r\n * @param {String} opts.access {public} - Access level (private, protected or public).\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @param {Object} opts.filteredKeys {} - Keys to filter for the current model\r\n * @returns {Array} - Keys to filter.\r\n */\r\nFilter.prototype.getExcluded = function (opts) {\r\n  if (opts.access === 'private') {\r\n    return []\r\n  }\r\n\r\n  let entry = opts.excludedMap && opts.modelName ? opts.excludedMap[opts.modelName] : null\r\n\r\n  if (!entry) {\r\n    entry = _.isPlainObject(opts.filteredKeys) ? {\r\n      private: opts.filteredKeys.private || [],\r\n      protected: opts.filteredKeys.protected || []\r\n    } : {\r\n      private: [],\r\n      protected: []\r\n    }\r\n  }\r\n\r\n  return opts.access === 'protected' ? entry.private : entry.private.concat(entry.protected)\r\n}\r\n\r\nFilter.prototype.isExcluded = function (field, opts) {\r\n  if (!field) {\r\n    return false\r\n  }\r\n\r\n  opts = _.defaults(opts, {\r\n    access: 'public',\r\n    excludedMap: {},\r\n    filteredKeys: this.filteredKeys,\r\n    modelName: this.model.modelName\r\n  })\r\n\r\n  return this.getExcluded(opts).indexOf(field) >= 0\r\n}\r\n\r\n/**\r\n * Removes excluded keys from a document.\r\n * @memberof Filter\r\n * @param {Object} - Source document.\r\n * @param {Array} - Keys to filter.\r\n * @returns {Object} - Filtered document.\r\n */\r\nFilter.prototype.filterItem = function (item, excluded) {\r\n  if (_.isArray(item)) {\r\n    return item.map((i) => this.filterItem(i, excluded))\r\n  }\r\n\r\n  if (item && excluded) {\r\n    if (_.isFunction(item.toObject)) {\r\n      item = item.toObject()\r\n    }\r\n\r\n    for (let i = 0, length = excluded.length; i < length; i++) {\r\n      if (excluded[i].indexOf('.') > 0) {\r\n        weedout(item, excluded[i])\r\n      } else {\r\n        delete item[excluded[i]]\r\n      }\r\n    }\r\n  }\r\n\r\n  return item\r\n}\r\n\r\n/**\r\n * Removes excluded keys from a document with populated subdocuments.\r\n * @memberof Filter\r\n * @param {Object} - Source document.\r\n * @param {Object} - Keys to filter.\r\n * @param {Array} opts.populate - Paths to populated subdocuments.\r\n * @param {String} opts.access - Access level (private, protected or public).\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @returns {Object} - Filtered document.\r\n */\r\nFilter.prototype.filterPopulatedItem = function (item, opts) {\r\n  if (_.isArray(item)) {\r\n    return item.map((i) => this.filterPopulatedItem(i, opts))\r\n  }\r\n\r\n  for (let i = 0; i < opts.populate.length; i++) {\r\n    if (!opts.populate[i].path) {\r\n      continue\r\n    }\r\n\r\n    const excluded = this.getExcluded({\r\n      access: opts.access,\r\n      excludedMap: opts.excludedMap,\r\n      modelName: detective(this.model, opts.populate[i].path)\r\n    })\r\n\r\n    if (_.has(item, opts.populate[i].path)) {\r\n      this.filterItem(_.get(item, opts.populate[i].path), excluded)\r\n    } else {\r\n      const pathToArray = opts.populate[i].path.split('.').slice(0, -1).join('.')\r\n\r\n      if (_.has(item, pathToArray)) {\r\n        const array = _.get(item, pathToArray)\r\n        const pathToObject = opts.populate[i].path.split('.').slice(-1).join('.')\r\n\r\n        this.filterItem(_.map(array, pathToObject), excluded)\r\n      }\r\n    }\r\n  }\r\n\r\n  return item\r\n}\r\n\r\n/**\r\n * Removes excluded keys from a document.\r\n * @memberof Filter\r\n * @access public\r\n * @param {Object} - Source document.\r\n * @param {Object} - Options.\r\n * @param {String} opts.access {public} - Access level (private, protected or public).\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @param {Array} opts.populate - Paths to populated subdocuments.\r\n * @returns {Object} - Filtered document.\r\n */\r\nFilter.prototype.filterObject = function (resource, opts = {}) {\r\n  opts = _.defaults(opts, {\r\n    access: 'public',\r\n    excludedMap: {},\r\n    filteredKeys: this.filteredKeys,\r\n    modelName: this.model.modelName\r\n  })\r\n\r\n  let filtered = this.filterItem(resource, this.getExcluded(opts))\r\n\r\n  if (opts.populate) {\r\n    this.filterPopulatedItem(filtered, opts)\r\n  }\r\n\r\n  return filtered\r\n}\r\n\r\nmodule.exports = Filter\r\n"]}