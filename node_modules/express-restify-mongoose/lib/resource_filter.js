'use strict';

var _ = require('lodash');
var detective = require('mongoose-detective');
var weedout = require('weedout');

/**
 * Represents a filter.
 * @constructor
 * @param {Object} opts - Options
 * @param {Object} opts.model - Mongoose model
 * @param {Object} opts.excludedMap {} - Filtered keys for related models
 * @param {Object} opts.filteredKeys {} - Keys to filter for the current model
 */
function Filter(opts) {
  this.model = opts.model;

  this.filteredKeys = _.isPlainObject(opts.filteredKeys) ? {
    private: opts.filteredKeys.private || [],
    protected: opts.filteredKeys.protected || []
  } : {
    private: [],
    protected: []
  };

  if (this.model && this.model.discriminators && _.isPlainObject(opts.excludedMap)) {
    for (var modelName in this.model.discriminators) {
      if (opts.excludedMap[modelName]) {
        this.filteredKeys.private = this.filteredKeys.private.concat(opts.excludedMap[modelName].private);
        this.filteredKeys.protected = this.filteredKeys.protected.concat(opts.excludedMap[modelName].protected);
      }
    }
  }
}

/**
 * Gets excluded keys for a given model and access.
 * @memberof Filter
 * @param {Object} - Options.
 * @param {String} opts.access {public} - Access level (private, protected or public).
 * @param {Object} opts.excludedMap {} - Filtered keys for related models
 * @param {Object} opts.filteredKeys {} - Keys to filter for the current model
 * @returns {Array} - Keys to filter.
 */
Filter.prototype.getExcluded = function (opts) {
  if (opts.access === 'private') {
    return [];
  }

  var entry = opts.excludedMap && opts.modelName ? opts.excludedMap[opts.modelName] : null;

  if (!entry) {
    entry = _.isPlainObject(opts.filteredKeys) ? {
      private: opts.filteredKeys.private || [],
      protected: opts.filteredKeys.protected || []
    } : {
      private: [],
      protected: []
    };
  }

  return opts.access === 'protected' ? entry.private : entry.private.concat(entry.protected);
};

Filter.prototype.isExcluded = function (field, opts) {
  if (!field) {
    return false;
  }

  opts = _.defaults(opts, {
    access: 'public',
    excludedMap: {},
    filteredKeys: this.filteredKeys,
    modelName: this.model.modelName
  });

  return this.getExcluded(opts).indexOf(field) >= 0;
};

/**
 * Removes excluded keys from a document.
 * @memberof Filter
 * @param {Object} - Source document.
 * @param {Array} - Keys to filter.
 * @returns {Object} - Filtered document.
 */
Filter.prototype.filterItem = function (item, excluded) {
  var _this = this;

  if (_.isArray(item)) {
    return item.map(function (i) {
      return _this.filterItem(i, excluded);
    });
  }

  if (item && excluded) {
    if (_.isFunction(item.toObject)) {
      item = item.toObject();
    }

    for (var i = 0, length = excluded.length; i < length; i++) {
      if (excluded[i].indexOf('.') > 0) {
        weedout(item, excluded[i]);
      } else {
        delete item[excluded[i]];
      }
    }
  }

  return item;
};

/**
 * Removes excluded keys from a document with populated subdocuments.
 * @memberof Filter
 * @param {Object} - Source document.
 * @param {Object} - Keys to filter.
 * @param {Array} opts.populate - Paths to populated subdocuments.
 * @param {String} opts.access - Access level (private, protected or public).
 * @param {Object} opts.excludedMap {} - Filtered keys for related models
 * @returns {Object} - Filtered document.
 */
Filter.prototype.filterPopulatedItem = function (item, opts) {
  var _this2 = this;

  if (_.isArray(item)) {
    return item.map(function (i) {
      return _this2.filterPopulatedItem(i, opts);
    });
  }

  for (var i = 0; i < opts.populate.length; i++) {
    if (!opts.populate[i].path) {
      continue;
    }

    var excluded = this.getExcluded({
      access: opts.access,
      excludedMap: opts.excludedMap,
      modelName: detective(this.model, opts.populate[i].path)
    });

    if (_.has(item, opts.populate[i].path)) {
      this.filterItem(_.get(item, opts.populate[i].path), excluded);
    } else {
      var pathToArray = opts.populate[i].path.split('.').slice(0, -1).join('.');

      if (_.has(item, pathToArray)) {
        var array = _.get(item, pathToArray);
        var pathToObject = opts.populate[i].path.split('.').slice(-1).join('.');

        this.filterItem(_.map(array, pathToObject), excluded);
      }
    }
  }

  return item;
};

/**
 * Removes excluded keys from a document.
 * @memberof Filter
 * @access public
 * @param {Object} - Source document.
 * @param {Object} - Options.
 * @param {String} opts.access {public} - Access level (private, protected or public).
 * @param {Object} opts.excludedMap {} - Filtered keys for related models
 * @param {Array} opts.populate - Paths to populated subdocuments.
 * @returns {Object} - Filtered document.
 */
Filter.prototype.filterObject = function (resource) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  opts = _.defaults(opts, {
    access: 'public',
    excludedMap: {},
    filteredKeys: this.filteredKeys,
    modelName: this.model.modelName
  });

  var filtered = this.filterItem(resource, this.getExcluded(opts));

  if (opts.populate) {
    this.filterPopulatedItem(filtered, opts);
  }

  return filtered;
};

module.exports = Filter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXNvdXJjZV9maWx0ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNLElBQUksUUFBUSxRQUFSLENBQVY7QUFDQSxJQUFNLFlBQVksUUFBUSxvQkFBUixDQUFsQjtBQUNBLElBQU0sVUFBVSxRQUFRLFNBQVIsQ0FBaEI7O0FBRUE7Ozs7Ozs7O0FBUUEsU0FBUyxNQUFULENBQWlCLElBQWpCLEVBQXVCO0FBQ3JCLE9BQUssS0FBTCxHQUFhLEtBQUssS0FBbEI7O0FBRUEsT0FBSyxZQUFMLEdBQW9CLEVBQUUsYUFBRixDQUFnQixLQUFLLFlBQXJCLElBQXFDO0FBQ3ZELGFBQVMsS0FBSyxZQUFMLENBQWtCLE9BQWxCLElBQTZCLEVBRGlCO0FBRXZELGVBQVcsS0FBSyxZQUFMLENBQWtCLFNBQWxCLElBQStCO0FBRmEsR0FBckMsR0FHaEI7QUFDRixhQUFTLEVBRFA7QUFFRixlQUFXO0FBRlQsR0FISjs7QUFRQSxNQUFJLEtBQUssS0FBTCxJQUFjLEtBQUssS0FBTCxDQUFXLGNBQXpCLElBQTJDLEVBQUUsYUFBRixDQUFnQixLQUFLLFdBQXJCLENBQS9DLEVBQWtGO0FBQ2hGLFNBQUssSUFBSSxTQUFULElBQXNCLEtBQUssS0FBTCxDQUFXLGNBQWpDLEVBQWlEO0FBQy9DLFVBQUksS0FBSyxXQUFMLENBQWlCLFNBQWpCLENBQUosRUFBaUM7QUFDL0IsYUFBSyxZQUFMLENBQWtCLE9BQWxCLEdBQTRCLEtBQUssWUFBTCxDQUFrQixPQUFsQixDQUEwQixNQUExQixDQUFpQyxLQUFLLFdBQUwsQ0FBaUIsU0FBakIsRUFBNEIsT0FBN0QsQ0FBNUI7QUFDQSxhQUFLLFlBQUwsQ0FBa0IsU0FBbEIsR0FBOEIsS0FBSyxZQUFMLENBQWtCLFNBQWxCLENBQTRCLE1BQTVCLENBQW1DLEtBQUssV0FBTCxDQUFpQixTQUFqQixFQUE0QixTQUEvRCxDQUE5QjtBQUNEO0FBQ0Y7QUFDRjtBQUNGOztBQUVEOzs7Ozs7Ozs7QUFTQSxPQUFPLFNBQVAsQ0FBaUIsV0FBakIsR0FBK0IsVUFBVSxJQUFWLEVBQWdCO0FBQzdDLE1BQUksS0FBSyxNQUFMLEtBQWdCLFNBQXBCLEVBQStCO0FBQzdCLFdBQU8sRUFBUDtBQUNEOztBQUVELE1BQUksUUFBUSxLQUFLLFdBQUwsSUFBb0IsS0FBSyxTQUF6QixHQUFxQyxLQUFLLFdBQUwsQ0FBaUIsS0FBSyxTQUF0QixDQUFyQyxHQUF3RSxJQUFwRjs7QUFFQSxNQUFJLENBQUMsS0FBTCxFQUFZO0FBQ1YsWUFBUSxFQUFFLGFBQUYsQ0FBZ0IsS0FBSyxZQUFyQixJQUFxQztBQUMzQyxlQUFTLEtBQUssWUFBTCxDQUFrQixPQUFsQixJQUE2QixFQURLO0FBRTNDLGlCQUFXLEtBQUssWUFBTCxDQUFrQixTQUFsQixJQUErQjtBQUZDLEtBQXJDLEdBR0o7QUFDRixlQUFTLEVBRFA7QUFFRixpQkFBVztBQUZULEtBSEo7QUFPRDs7QUFFRCxTQUFPLEtBQUssTUFBTCxLQUFnQixXQUFoQixHQUE4QixNQUFNLE9BQXBDLEdBQThDLE1BQU0sT0FBTixDQUFjLE1BQWQsQ0FBcUIsTUFBTSxTQUEzQixDQUFyRDtBQUNELENBbEJEOztBQW9CQSxPQUFPLFNBQVAsQ0FBaUIsVUFBakIsR0FBOEIsVUFBVSxLQUFWLEVBQWlCLElBQWpCLEVBQXVCO0FBQ25ELE1BQUksQ0FBQyxLQUFMLEVBQVk7QUFDVixXQUFPLEtBQVA7QUFDRDs7QUFFRCxTQUFPLEVBQUUsUUFBRixDQUFXLElBQVgsRUFBaUI7QUFDdEIsWUFBUSxRQURjO0FBRXRCLGlCQUFhLEVBRlM7QUFHdEIsa0JBQWMsS0FBSyxZQUhHO0FBSXRCLGVBQVcsS0FBSyxLQUFMLENBQVc7QUFKQSxHQUFqQixDQUFQOztBQU9BLFNBQU8sS0FBSyxXQUFMLENBQWlCLElBQWpCLEVBQXVCLE9BQXZCLENBQStCLEtBQS9CLEtBQXlDLENBQWhEO0FBQ0QsQ0FiRDs7QUFlQTs7Ozs7OztBQU9BLE9BQU8sU0FBUCxDQUFpQixVQUFqQixHQUE4QixVQUFVLElBQVYsRUFBZ0IsUUFBaEIsRUFBMEI7QUFBQTs7QUFDdEQsTUFBSSxFQUFFLE9BQUYsQ0FBVSxJQUFWLENBQUosRUFBcUI7QUFDbkIsV0FBTyxLQUFLLEdBQUwsQ0FBUyxVQUFDLENBQUQ7QUFBQSxhQUFPLE1BQUssVUFBTCxDQUFnQixDQUFoQixFQUFtQixRQUFuQixDQUFQO0FBQUEsS0FBVCxDQUFQO0FBQ0Q7O0FBRUQsTUFBSSxRQUFRLFFBQVosRUFBc0I7QUFDcEIsUUFBSSxFQUFFLFVBQUYsQ0FBYSxLQUFLLFFBQWxCLENBQUosRUFBaUM7QUFDL0IsYUFBTyxLQUFLLFFBQUwsRUFBUDtBQUNEOztBQUVELFNBQUssSUFBSSxJQUFJLENBQVIsRUFBVyxTQUFTLFNBQVMsTUFBbEMsRUFBMEMsSUFBSSxNQUE5QyxFQUFzRCxHQUF0RCxFQUEyRDtBQUN6RCxVQUFJLFNBQVMsQ0FBVCxFQUFZLE9BQVosQ0FBb0IsR0FBcEIsSUFBMkIsQ0FBL0IsRUFBa0M7QUFDaEMsZ0JBQVEsSUFBUixFQUFjLFNBQVMsQ0FBVCxDQUFkO0FBQ0QsT0FGRCxNQUVPO0FBQ0wsZUFBTyxLQUFLLFNBQVMsQ0FBVCxDQUFMLENBQVA7QUFDRDtBQUNGO0FBQ0Y7O0FBRUQsU0FBTyxJQUFQO0FBQ0QsQ0FwQkQ7O0FBc0JBOzs7Ozs7Ozs7O0FBVUEsT0FBTyxTQUFQLENBQWlCLG1CQUFqQixHQUF1QyxVQUFVLElBQVYsRUFBZ0IsSUFBaEIsRUFBc0I7QUFBQTs7QUFDM0QsTUFBSSxFQUFFLE9BQUYsQ0FBVSxJQUFWLENBQUosRUFBcUI7QUFDbkIsV0FBTyxLQUFLLEdBQUwsQ0FBUyxVQUFDLENBQUQ7QUFBQSxhQUFPLE9BQUssbUJBQUwsQ0FBeUIsQ0FBekIsRUFBNEIsSUFBNUIsQ0FBUDtBQUFBLEtBQVQsQ0FBUDtBQUNEOztBQUVELE9BQUssSUFBSSxJQUFJLENBQWIsRUFBZ0IsSUFBSSxLQUFLLFFBQUwsQ0FBYyxNQUFsQyxFQUEwQyxHQUExQyxFQUErQztBQUM3QyxRQUFJLENBQUMsS0FBSyxRQUFMLENBQWMsQ0FBZCxFQUFpQixJQUF0QixFQUE0QjtBQUMxQjtBQUNEOztBQUVELFFBQU0sV0FBVyxLQUFLLFdBQUwsQ0FBaUI7QUFDaEMsY0FBUSxLQUFLLE1BRG1CO0FBRWhDLG1CQUFhLEtBQUssV0FGYztBQUdoQyxpQkFBVyxVQUFVLEtBQUssS0FBZixFQUFzQixLQUFLLFFBQUwsQ0FBYyxDQUFkLEVBQWlCLElBQXZDO0FBSHFCLEtBQWpCLENBQWpCOztBQU1BLFFBQUksRUFBRSxHQUFGLENBQU0sSUFBTixFQUFZLEtBQUssUUFBTCxDQUFjLENBQWQsRUFBaUIsSUFBN0IsQ0FBSixFQUF3QztBQUN0QyxXQUFLLFVBQUwsQ0FBZ0IsRUFBRSxHQUFGLENBQU0sSUFBTixFQUFZLEtBQUssUUFBTCxDQUFjLENBQWQsRUFBaUIsSUFBN0IsQ0FBaEIsRUFBb0QsUUFBcEQ7QUFDRCxLQUZELE1BRU87QUFDTCxVQUFNLGNBQWMsS0FBSyxRQUFMLENBQWMsQ0FBZCxFQUFpQixJQUFqQixDQUFzQixLQUF0QixDQUE0QixHQUE1QixFQUFpQyxLQUFqQyxDQUF1QyxDQUF2QyxFQUEwQyxDQUFDLENBQTNDLEVBQThDLElBQTlDLENBQW1ELEdBQW5ELENBQXBCOztBQUVBLFVBQUksRUFBRSxHQUFGLENBQU0sSUFBTixFQUFZLFdBQVosQ0FBSixFQUE4QjtBQUM1QixZQUFNLFFBQVEsRUFBRSxHQUFGLENBQU0sSUFBTixFQUFZLFdBQVosQ0FBZDtBQUNBLFlBQU0sZUFBZSxLQUFLLFFBQUwsQ0FBYyxDQUFkLEVBQWlCLElBQWpCLENBQXNCLEtBQXRCLENBQTRCLEdBQTVCLEVBQWlDLEtBQWpDLENBQXVDLENBQUMsQ0FBeEMsRUFBMkMsSUFBM0MsQ0FBZ0QsR0FBaEQsQ0FBckI7O0FBRUEsYUFBSyxVQUFMLENBQWdCLEVBQUUsR0FBRixDQUFNLEtBQU4sRUFBYSxZQUFiLENBQWhCLEVBQTRDLFFBQTVDO0FBQ0Q7QUFDRjtBQUNGOztBQUVELFNBQU8sSUFBUDtBQUNELENBL0JEOztBQWlDQTs7Ozs7Ozs7Ozs7QUFXQSxPQUFPLFNBQVAsQ0FBaUIsWUFBakIsR0FBZ0MsVUFBVSxRQUFWLEVBQStCO0FBQUEsTUFBWCxJQUFXLHlEQUFKLEVBQUk7O0FBQzdELFNBQU8sRUFBRSxRQUFGLENBQVcsSUFBWCxFQUFpQjtBQUN0QixZQUFRLFFBRGM7QUFFdEIsaUJBQWEsRUFGUztBQUd0QixrQkFBYyxLQUFLLFlBSEc7QUFJdEIsZUFBVyxLQUFLLEtBQUwsQ0FBVztBQUpBLEdBQWpCLENBQVA7O0FBT0EsTUFBSSxXQUFXLEtBQUssVUFBTCxDQUFnQixRQUFoQixFQUEwQixLQUFLLFdBQUwsQ0FBaUIsSUFBakIsQ0FBMUIsQ0FBZjs7QUFFQSxNQUFJLEtBQUssUUFBVCxFQUFtQjtBQUNqQixTQUFLLG1CQUFMLENBQXlCLFFBQXpCLEVBQW1DLElBQW5DO0FBQ0Q7O0FBRUQsU0FBTyxRQUFQO0FBQ0QsQ0FmRDs7QUFpQkEsT0FBTyxPQUFQLEdBQWlCLE1BQWpCIiwiZmlsZSI6InJlc291cmNlX2ZpbHRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxyXG5jb25zdCBkZXRlY3RpdmUgPSByZXF1aXJlKCdtb25nb29zZS1kZXRlY3RpdmUnKVxyXG5jb25zdCB3ZWVkb3V0ID0gcmVxdWlyZSgnd2VlZG91dCcpXHJcblxyXG4vKipcclxuICogUmVwcmVzZW50cyBhIGZpbHRlci5cclxuICogQGNvbnN0cnVjdG9yXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIC0gT3B0aW9uc1xyXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cy5tb2RlbCAtIE1vbmdvb3NlIG1vZGVsXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzLmV4Y2x1ZGVkTWFwIHt9IC0gRmlsdGVyZWQga2V5cyBmb3IgcmVsYXRlZCBtb2RlbHNcclxuICogQHBhcmFtIHtPYmplY3R9IG9wdHMuZmlsdGVyZWRLZXlzIHt9IC0gS2V5cyB0byBmaWx0ZXIgZm9yIHRoZSBjdXJyZW50IG1vZGVsXHJcbiAqL1xyXG5mdW5jdGlvbiBGaWx0ZXIgKG9wdHMpIHtcclxuICB0aGlzLm1vZGVsID0gb3B0cy5tb2RlbFxyXG5cclxuICB0aGlzLmZpbHRlcmVkS2V5cyA9IF8uaXNQbGFpbk9iamVjdChvcHRzLmZpbHRlcmVkS2V5cykgPyB7XHJcbiAgICBwcml2YXRlOiBvcHRzLmZpbHRlcmVkS2V5cy5wcml2YXRlIHx8IFtdLFxyXG4gICAgcHJvdGVjdGVkOiBvcHRzLmZpbHRlcmVkS2V5cy5wcm90ZWN0ZWQgfHwgW11cclxuICB9IDoge1xyXG4gICAgcHJpdmF0ZTogW10sXHJcbiAgICBwcm90ZWN0ZWQ6IFtdXHJcbiAgfVxyXG5cclxuICBpZiAodGhpcy5tb2RlbCAmJiB0aGlzLm1vZGVsLmRpc2NyaW1pbmF0b3JzICYmIF8uaXNQbGFpbk9iamVjdChvcHRzLmV4Y2x1ZGVkTWFwKSkge1xyXG4gICAgZm9yIChsZXQgbW9kZWxOYW1lIGluIHRoaXMubW9kZWwuZGlzY3JpbWluYXRvcnMpIHtcclxuICAgICAgaWYgKG9wdHMuZXhjbHVkZWRNYXBbbW9kZWxOYW1lXSkge1xyXG4gICAgICAgIHRoaXMuZmlsdGVyZWRLZXlzLnByaXZhdGUgPSB0aGlzLmZpbHRlcmVkS2V5cy5wcml2YXRlLmNvbmNhdChvcHRzLmV4Y2x1ZGVkTWFwW21vZGVsTmFtZV0ucHJpdmF0ZSlcclxuICAgICAgICB0aGlzLmZpbHRlcmVkS2V5cy5wcm90ZWN0ZWQgPSB0aGlzLmZpbHRlcmVkS2V5cy5wcm90ZWN0ZWQuY29uY2F0KG9wdHMuZXhjbHVkZWRNYXBbbW9kZWxOYW1lXS5wcm90ZWN0ZWQpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHZXRzIGV4Y2x1ZGVkIGtleXMgZm9yIGEgZ2l2ZW4gbW9kZWwgYW5kIGFjY2Vzcy5cclxuICogQG1lbWJlcm9mIEZpbHRlclxyXG4gKiBAcGFyYW0ge09iamVjdH0gLSBPcHRpb25zLlxyXG4gKiBAcGFyYW0ge1N0cmluZ30gb3B0cy5hY2Nlc3Mge3B1YmxpY30gLSBBY2Nlc3MgbGV2ZWwgKHByaXZhdGUsIHByb3RlY3RlZCBvciBwdWJsaWMpLlxyXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cy5leGNsdWRlZE1hcCB7fSAtIEZpbHRlcmVkIGtleXMgZm9yIHJlbGF0ZWQgbW9kZWxzXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzLmZpbHRlcmVkS2V5cyB7fSAtIEtleXMgdG8gZmlsdGVyIGZvciB0aGUgY3VycmVudCBtb2RlbFxyXG4gKiBAcmV0dXJucyB7QXJyYXl9IC0gS2V5cyB0byBmaWx0ZXIuXHJcbiAqL1xyXG5GaWx0ZXIucHJvdG90eXBlLmdldEV4Y2x1ZGVkID0gZnVuY3Rpb24gKG9wdHMpIHtcclxuICBpZiAob3B0cy5hY2Nlc3MgPT09ICdwcml2YXRlJykge1xyXG4gICAgcmV0dXJuIFtdXHJcbiAgfVxyXG5cclxuICBsZXQgZW50cnkgPSBvcHRzLmV4Y2x1ZGVkTWFwICYmIG9wdHMubW9kZWxOYW1lID8gb3B0cy5leGNsdWRlZE1hcFtvcHRzLm1vZGVsTmFtZV0gOiBudWxsXHJcblxyXG4gIGlmICghZW50cnkpIHtcclxuICAgIGVudHJ5ID0gXy5pc1BsYWluT2JqZWN0KG9wdHMuZmlsdGVyZWRLZXlzKSA/IHtcclxuICAgICAgcHJpdmF0ZTogb3B0cy5maWx0ZXJlZEtleXMucHJpdmF0ZSB8fCBbXSxcclxuICAgICAgcHJvdGVjdGVkOiBvcHRzLmZpbHRlcmVkS2V5cy5wcm90ZWN0ZWQgfHwgW11cclxuICAgIH0gOiB7XHJcbiAgICAgIHByaXZhdGU6IFtdLFxyXG4gICAgICBwcm90ZWN0ZWQ6IFtdXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gb3B0cy5hY2Nlc3MgPT09ICdwcm90ZWN0ZWQnID8gZW50cnkucHJpdmF0ZSA6IGVudHJ5LnByaXZhdGUuY29uY2F0KGVudHJ5LnByb3RlY3RlZClcclxufVxyXG5cclxuRmlsdGVyLnByb3RvdHlwZS5pc0V4Y2x1ZGVkID0gZnVuY3Rpb24gKGZpZWxkLCBvcHRzKSB7XHJcbiAgaWYgKCFmaWVsZCkge1xyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG5cclxuICBvcHRzID0gXy5kZWZhdWx0cyhvcHRzLCB7XHJcbiAgICBhY2Nlc3M6ICdwdWJsaWMnLFxyXG4gICAgZXhjbHVkZWRNYXA6IHt9LFxyXG4gICAgZmlsdGVyZWRLZXlzOiB0aGlzLmZpbHRlcmVkS2V5cyxcclxuICAgIG1vZGVsTmFtZTogdGhpcy5tb2RlbC5tb2RlbE5hbWVcclxuICB9KVxyXG5cclxuICByZXR1cm4gdGhpcy5nZXRFeGNsdWRlZChvcHRzKS5pbmRleE9mKGZpZWxkKSA+PSAwXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBSZW1vdmVzIGV4Y2x1ZGVkIGtleXMgZnJvbSBhIGRvY3VtZW50LlxyXG4gKiBAbWVtYmVyb2YgRmlsdGVyXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSAtIFNvdXJjZSBkb2N1bWVudC5cclxuICogQHBhcmFtIHtBcnJheX0gLSBLZXlzIHRvIGZpbHRlci5cclxuICogQHJldHVybnMge09iamVjdH0gLSBGaWx0ZXJlZCBkb2N1bWVudC5cclxuICovXHJcbkZpbHRlci5wcm90b3R5cGUuZmlsdGVySXRlbSA9IGZ1bmN0aW9uIChpdGVtLCBleGNsdWRlZCkge1xyXG4gIGlmIChfLmlzQXJyYXkoaXRlbSkpIHtcclxuICAgIHJldHVybiBpdGVtLm1hcCgoaSkgPT4gdGhpcy5maWx0ZXJJdGVtKGksIGV4Y2x1ZGVkKSlcclxuICB9XHJcblxyXG4gIGlmIChpdGVtICYmIGV4Y2x1ZGVkKSB7XHJcbiAgICBpZiAoXy5pc0Z1bmN0aW9uKGl0ZW0udG9PYmplY3QpKSB7XHJcbiAgICAgIGl0ZW0gPSBpdGVtLnRvT2JqZWN0KClcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuZ3RoID0gZXhjbHVkZWQubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgaWYgKGV4Y2x1ZGVkW2ldLmluZGV4T2YoJy4nKSA+IDApIHtcclxuICAgICAgICB3ZWVkb3V0KGl0ZW0sIGV4Y2x1ZGVkW2ldKVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRlbGV0ZSBpdGVtW2V4Y2x1ZGVkW2ldXVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gaXRlbVxyXG59XHJcblxyXG4vKipcclxuICogUmVtb3ZlcyBleGNsdWRlZCBrZXlzIGZyb20gYSBkb2N1bWVudCB3aXRoIHBvcHVsYXRlZCBzdWJkb2N1bWVudHMuXHJcbiAqIEBtZW1iZXJvZiBGaWx0ZXJcclxuICogQHBhcmFtIHtPYmplY3R9IC0gU291cmNlIGRvY3VtZW50LlxyXG4gKiBAcGFyYW0ge09iamVjdH0gLSBLZXlzIHRvIGZpbHRlci5cclxuICogQHBhcmFtIHtBcnJheX0gb3B0cy5wb3B1bGF0ZSAtIFBhdGhzIHRvIHBvcHVsYXRlZCBzdWJkb2N1bWVudHMuXHJcbiAqIEBwYXJhbSB7U3RyaW5nfSBvcHRzLmFjY2VzcyAtIEFjY2VzcyBsZXZlbCAocHJpdmF0ZSwgcHJvdGVjdGVkIG9yIHB1YmxpYykuXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzLmV4Y2x1ZGVkTWFwIHt9IC0gRmlsdGVyZWQga2V5cyBmb3IgcmVsYXRlZCBtb2RlbHNcclxuICogQHJldHVybnMge09iamVjdH0gLSBGaWx0ZXJlZCBkb2N1bWVudC5cclxuICovXHJcbkZpbHRlci5wcm90b3R5cGUuZmlsdGVyUG9wdWxhdGVkSXRlbSA9IGZ1bmN0aW9uIChpdGVtLCBvcHRzKSB7XHJcbiAgaWYgKF8uaXNBcnJheShpdGVtKSkge1xyXG4gICAgcmV0dXJuIGl0ZW0ubWFwKChpKSA9PiB0aGlzLmZpbHRlclBvcHVsYXRlZEl0ZW0oaSwgb3B0cykpXHJcbiAgfVxyXG5cclxuICBmb3IgKGxldCBpID0gMDsgaSA8IG9wdHMucG9wdWxhdGUubGVuZ3RoOyBpKyspIHtcclxuICAgIGlmICghb3B0cy5wb3B1bGF0ZVtpXS5wYXRoKSB7XHJcbiAgICAgIGNvbnRpbnVlXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZXhjbHVkZWQgPSB0aGlzLmdldEV4Y2x1ZGVkKHtcclxuICAgICAgYWNjZXNzOiBvcHRzLmFjY2VzcyxcclxuICAgICAgZXhjbHVkZWRNYXA6IG9wdHMuZXhjbHVkZWRNYXAsXHJcbiAgICAgIG1vZGVsTmFtZTogZGV0ZWN0aXZlKHRoaXMubW9kZWwsIG9wdHMucG9wdWxhdGVbaV0ucGF0aClcclxuICAgIH0pXHJcblxyXG4gICAgaWYgKF8uaGFzKGl0ZW0sIG9wdHMucG9wdWxhdGVbaV0ucGF0aCkpIHtcclxuICAgICAgdGhpcy5maWx0ZXJJdGVtKF8uZ2V0KGl0ZW0sIG9wdHMucG9wdWxhdGVbaV0ucGF0aCksIGV4Y2x1ZGVkKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc3QgcGF0aFRvQXJyYXkgPSBvcHRzLnBvcHVsYXRlW2ldLnBhdGguc3BsaXQoJy4nKS5zbGljZSgwLCAtMSkuam9pbignLicpXHJcblxyXG4gICAgICBpZiAoXy5oYXMoaXRlbSwgcGF0aFRvQXJyYXkpKSB7XHJcbiAgICAgICAgY29uc3QgYXJyYXkgPSBfLmdldChpdGVtLCBwYXRoVG9BcnJheSlcclxuICAgICAgICBjb25zdCBwYXRoVG9PYmplY3QgPSBvcHRzLnBvcHVsYXRlW2ldLnBhdGguc3BsaXQoJy4nKS5zbGljZSgtMSkuam9pbignLicpXHJcblxyXG4gICAgICAgIHRoaXMuZmlsdGVySXRlbShfLm1hcChhcnJheSwgcGF0aFRvT2JqZWN0KSwgZXhjbHVkZWQpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBpdGVtXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBSZW1vdmVzIGV4Y2x1ZGVkIGtleXMgZnJvbSBhIGRvY3VtZW50LlxyXG4gKiBAbWVtYmVyb2YgRmlsdGVyXHJcbiAqIEBhY2Nlc3MgcHVibGljXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSAtIFNvdXJjZSBkb2N1bWVudC5cclxuICogQHBhcmFtIHtPYmplY3R9IC0gT3B0aW9ucy5cclxuICogQHBhcmFtIHtTdHJpbmd9IG9wdHMuYWNjZXNzIHtwdWJsaWN9IC0gQWNjZXNzIGxldmVsIChwcml2YXRlLCBwcm90ZWN0ZWQgb3IgcHVibGljKS5cclxuICogQHBhcmFtIHtPYmplY3R9IG9wdHMuZXhjbHVkZWRNYXAge30gLSBGaWx0ZXJlZCBrZXlzIGZvciByZWxhdGVkIG1vZGVsc1xyXG4gKiBAcGFyYW0ge0FycmF5fSBvcHRzLnBvcHVsYXRlIC0gUGF0aHMgdG8gcG9wdWxhdGVkIHN1YmRvY3VtZW50cy5cclxuICogQHJldHVybnMge09iamVjdH0gLSBGaWx0ZXJlZCBkb2N1bWVudC5cclxuICovXHJcbkZpbHRlci5wcm90b3R5cGUuZmlsdGVyT2JqZWN0ID0gZnVuY3Rpb24gKHJlc291cmNlLCBvcHRzID0ge30pIHtcclxuICBvcHRzID0gXy5kZWZhdWx0cyhvcHRzLCB7XHJcbiAgICBhY2Nlc3M6ICdwdWJsaWMnLFxyXG4gICAgZXhjbHVkZWRNYXA6IHt9LFxyXG4gICAgZmlsdGVyZWRLZXlzOiB0aGlzLmZpbHRlcmVkS2V5cyxcclxuICAgIG1vZGVsTmFtZTogdGhpcy5tb2RlbC5tb2RlbE5hbWVcclxuICB9KVxyXG5cclxuICBsZXQgZmlsdGVyZWQgPSB0aGlzLmZpbHRlckl0ZW0ocmVzb3VyY2UsIHRoaXMuZ2V0RXhjbHVkZWQob3B0cykpXHJcblxyXG4gIGlmIChvcHRzLnBvcHVsYXRlKSB7XHJcbiAgICB0aGlzLmZpbHRlclBvcHVsYXRlZEl0ZW0oZmlsdGVyZWQsIG9wdHMpXHJcbiAgfVxyXG5cclxuICByZXR1cm4gZmlsdGVyZWRcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBGaWx0ZXJcclxuIl19
//# sourceMappingURL=resource_filter.js.map