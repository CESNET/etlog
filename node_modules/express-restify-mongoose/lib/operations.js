'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var _ = require('lodash');
var http = require('http');
var moredots = require('moredots');

module.exports = function (model, options, excludedMap) {
  var buildQuery = require('./buildQuery')(options);
  var errorHandler = require('./errorHandler')(options);

  function findById(filteredContext, id) {
    return filteredContext.findOne().and(_defineProperty({}, options.idProperty, id));
  }

  function isDistinctExcluded(req) {
    return options.filter.isExcluded(req._ermQueryOptions['distinct'], {
      access: req.access,
      excludedMap: excludedMap
    });
  }

  function getItems(req, res, next) {
    if (isDistinctExcluded(req)) {
      req.erm.result = [];
      req.erm.statusCode = 200;
      return next();
    }

    options.contextFilter(model, req, function (filteredContext) {
      buildQuery(filteredContext.find(), req._ermQueryOptions).then(function (items) {
        req.erm.result = items;
        req.erm.statusCode = 200;

        if (options.totalCountHeader && !req._ermQueryOptions['distinct']) {
          buildQuery(filteredContext.count(), _.assign(req._ermQueryOptions, {
            skip: 0,
            limit: 0
          })).then(function (count) {
            req.erm.totalCount = count;
            next();
          }, errorHandler(req, res, next));
        } else {
          next();
        }
      }, errorHandler(req, res, next));
    });
  }

  function getCount(req, res, next) {
    options.contextFilter(model, req, function (filteredContext) {
      buildQuery(filteredContext.count(), req._ermQueryOptions).then(function (count) {
        req.erm.result = { count: count };
        req.erm.statusCode = 200;

        next();
      }, errorHandler(req, res, next));
    });
  }

  function getShallow(req, res, next) {
    options.contextFilter(model, req, function (filteredContext) {
      buildQuery(findById(filteredContext, req.params.id), req._ermQueryOptions).then(function (item) {
        if (!item) {
          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]));
        }

        for (var prop in item) {
          item[prop] = _typeof(item[prop]) === 'object' && prop !== '_id' ? true : item[prop];
        }

        req.erm.result = item;
        req.erm.statusCode = 200;

        next();
      }, errorHandler(req, res, next));
    });
  }

  function deleteItems(req, res, next) {
    options.contextFilter(model, req, function (filteredContext) {
      buildQuery(filteredContext.remove(), req._ermQueryOptions).then(function () {
        req.erm.statusCode = 204;

        next();
      }, errorHandler(req, res, next));
    });
  }

  function getItem(req, res, next) {
    if (isDistinctExcluded(req)) {
      req.erm.result = [];
      req.erm.statusCode = 200;
      return next();
    }

    options.contextFilter(model, req, function (filteredContext) {
      buildQuery(findById(filteredContext, req.params.id), req._ermQueryOptions).then(function (item) {
        if (!item) {
          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]));
        }

        req.erm.result = item;
        req.erm.statusCode = 200;

        next();
      }, errorHandler(req, res, next));
    });
  }

  function deleteItem(req, res, next) {
    if (options.findOneAndRemove) {
      options.contextFilter(model, req, function (filteredContext) {
        findById(filteredContext, req.params.id).findOneAndRemove().then(function (item) {
          if (!item) {
            return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]));
          }

          req.erm.statusCode = 204;

          next();
        }, errorHandler(req, res, next));
      });
    } else {
      req.erm.document.remove().then(function () {
        req.erm.statusCode = 204;

        next();
      }, errorHandler(req, res, next));
    }
  }

  function createObject(req, res, next) {
    req.body = options.filter.filterObject(req.body || {}, {
      access: req.access,
      populate: req._ermQueryOptions.populate
    });

    if (model.schema.options._id) {
      delete req.body._id;
    }

    if (model.schema.options.versionKey) {
      delete req.body[model.schema.options.versionKey];
    }

    model.create(req.body).then(function (item) {
      return model.populate(item, req._ermQueryOptions.populate || []);
    }).then(function (item) {
      req.erm.result = item;
      req.erm.statusCode = 201;

      next();
    }, errorHandler(req, res, next));
  }

  function modifyObject(req, res, next) {
    req.body = options.filter.filterObject(req.body || {}, {
      access: req.access,
      populate: req._ermQueryOptions.populate
    });

    delete req.body._id;

    if (model.schema.options.versionKey) {
      delete req.body[model.schema.options.versionKey];
    }

    function depopulate(src) {
      var dst = {};

      for (var key in src) {
        var path = model.schema.path(key);

        if (path && path.caster && path.caster.instance === 'ObjectID') {
          if (_.isArray(src[key])) {
            for (var j = 0; j < src[key].length; ++j) {
              if (_typeof(src[key][j]) === 'object') {
                dst[key] = dst[key] || {};
                dst[key][j] = src[key][j]._id;
              }
            }
          } else if (_.isPlainObject(src[key])) {
            dst[key] = src[key]._id;
          }
        } else if (_.isPlainObject(src[key])) {
          if (path && path.instance === 'ObjectID') {
            dst[key] = src[key]._id;
          } else {
            dst[key] = depopulate(src[key]);
          }
        }

        if (_.isUndefined(dst[key])) {
          dst[key] = src[key];
        }
      }

      return dst;
    }

    var cleanBody = moredots(depopulate(req.body));

    if (options.findOneAndUpdate) {
      options.contextFilter(model, req, function (filteredContext) {
        findById(filteredContext, req.params.id).findOneAndUpdate({}, {
          $set: cleanBody
        }, {
          new: true,
          runValidators: options.runValidators
        }).exec().then(function (item) {
          return model.populate(item, req._ermQueryOptions.populate || []);
        }).then(function (item) {
          if (!item) {
            return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]));
          }

          req.erm.result = item;
          req.erm.statusCode = 200;

          next();
        }, errorHandler(req, res, next));
      });
    } else {
      for (var key in cleanBody) {
        req.erm.document.set(key, cleanBody[key]);
      }

      req.erm.document.save().then(function (item) {
        return model.populate(item, req._ermQueryOptions.populate || []);
      }).then(function (item) {
        req.erm.result = item;
        req.erm.statusCode = 200;

        next();
      }, errorHandler(req, res, next));
    }
  }

  return { getItems: getItems, getCount: getCount, getItem: getItem, getShallow: getShallow, createObject: createObject, modifyObject: modifyObject, deleteItems: deleteItems, deleteItem: deleteItem };
};
//# sourceMappingURL=data:application/json;base64,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QUFxQixHQUFyQjs7QUFFQTtBQUNELE9BTEQsRUFLRyxhQUFhLEdBQWIsRUFBa0IsR0FBbEIsRUFBdUIsSUFBdkIsQ0FMSDtBQU1EO0FBQ0Y7O0FBRUQsU0FBTyxFQUFFLGtCQUFGLEVBQVksa0JBQVosRUFBc0IsZ0JBQXRCLEVBQStCLHNCQUEvQixFQUEyQywwQkFBM0MsRUFBeUQsMEJBQXpELEVBQXVFLHdCQUF2RSxFQUFvRixzQkFBcEYsRUFBUDtBQUNELENBck9EIiwiZmlsZSI6Im9wZXJhdGlvbnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJylcclxuY29uc3QgaHR0cCA9IHJlcXVpcmUoJ2h0dHAnKVxyXG5jb25zdCBtb3JlZG90cyA9IHJlcXVpcmUoJ21vcmVkb3RzJylcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zLCBleGNsdWRlZE1hcCkge1xyXG4gIGNvbnN0IGJ1aWxkUXVlcnkgPSByZXF1aXJlKCcuL2J1aWxkUXVlcnknKShvcHRpb25zKVxyXG4gIGNvbnN0IGVycm9ySGFuZGxlciA9IHJlcXVpcmUoJy4vZXJyb3JIYW5kbGVyJykob3B0aW9ucylcclxuXHJcbiAgZnVuY3Rpb24gZmluZEJ5SWQgKGZpbHRlcmVkQ29udGV4dCwgaWQpIHtcclxuICAgIHJldHVybiBmaWx0ZXJlZENvbnRleHQuZmluZE9uZSgpLmFuZCh7XHJcbiAgICAgIFtvcHRpb25zLmlkUHJvcGVydHldOiBpZFxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGlzRGlzdGluY3RFeGNsdWRlZCAocmVxKSB7XHJcbiAgICByZXR1cm4gb3B0aW9ucy5maWx0ZXIuaXNFeGNsdWRlZChyZXEuX2VybVF1ZXJ5T3B0aW9uc1snZGlzdGluY3QnXSwge1xyXG4gICAgICBhY2Nlc3M6IHJlcS5hY2Nlc3MsXHJcbiAgICAgIGV4Y2x1ZGVkTWFwOiBleGNsdWRlZE1hcFxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGdldEl0ZW1zIChyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgaWYgKGlzRGlzdGluY3RFeGNsdWRlZChyZXEpKSB7XHJcbiAgICAgIHJlcS5lcm0ucmVzdWx0ID0gW11cclxuICAgICAgcmVxLmVybS5zdGF0dXNDb2RlID0gMjAwXHJcbiAgICAgIHJldHVybiBuZXh0KClcclxuICAgIH1cclxuXHJcbiAgICBvcHRpb25zLmNvbnRleHRGaWx0ZXIobW9kZWwsIHJlcSwgKGZpbHRlcmVkQ29udGV4dCkgPT4ge1xyXG4gICAgICBidWlsZFF1ZXJ5KGZpbHRlcmVkQ29udGV4dC5maW5kKCksIHJlcS5fZXJtUXVlcnlPcHRpb25zKS50aGVuKChpdGVtcykgPT4ge1xyXG4gICAgICAgIHJlcS5lcm0ucmVzdWx0ID0gaXRlbXNcclxuICAgICAgICByZXEuZXJtLnN0YXR1c0NvZGUgPSAyMDBcclxuXHJcbiAgICAgICAgaWYgKG9wdGlvbnMudG90YWxDb3VudEhlYWRlciAmJiAhcmVxLl9lcm1RdWVyeU9wdGlvbnNbJ2Rpc3RpbmN0J10pIHtcclxuICAgICAgICAgIGJ1aWxkUXVlcnkoZmlsdGVyZWRDb250ZXh0LmNvdW50KCksIF8uYXNzaWduKHJlcS5fZXJtUXVlcnlPcHRpb25zLCB7XHJcbiAgICAgICAgICAgIHNraXA6IDAsXHJcbiAgICAgICAgICAgIGxpbWl0OiAwXHJcbiAgICAgICAgICB9KSkudGhlbigoY291bnQpID0+IHtcclxuICAgICAgICAgICAgcmVxLmVybS50b3RhbENvdW50ID0gY291bnRcclxuICAgICAgICAgICAgbmV4dCgpXHJcbiAgICAgICAgICB9LCBlcnJvckhhbmRsZXIocmVxLCByZXMsIG5leHQpKVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBuZXh0KClcclxuICAgICAgICB9XHJcbiAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZ2V0Q291bnQgKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICBvcHRpb25zLmNvbnRleHRGaWx0ZXIobW9kZWwsIHJlcSwgKGZpbHRlcmVkQ29udGV4dCkgPT4ge1xyXG4gICAgICBidWlsZFF1ZXJ5KGZpbHRlcmVkQ29udGV4dC5jb3VudCgpLCByZXEuX2VybVF1ZXJ5T3B0aW9ucykudGhlbigoY291bnQpID0+IHtcclxuICAgICAgICByZXEuZXJtLnJlc3VsdCA9IHsgY291bnQ6IGNvdW50IH1cclxuICAgICAgICByZXEuZXJtLnN0YXR1c0NvZGUgPSAyMDBcclxuXHJcbiAgICAgICAgbmV4dCgpXHJcbiAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZ2V0U2hhbGxvdyAocmVxLCByZXMsIG5leHQpIHtcclxuICAgIG9wdGlvbnMuY29udGV4dEZpbHRlcihtb2RlbCwgcmVxLCAoZmlsdGVyZWRDb250ZXh0KSA9PiB7XHJcbiAgICAgIGJ1aWxkUXVlcnkoZmluZEJ5SWQoZmlsdGVyZWRDb250ZXh0LCByZXEucGFyYW1zLmlkKSwgcmVxLl9lcm1RdWVyeU9wdGlvbnMpLnRoZW4oKGl0ZW0pID0+IHtcclxuICAgICAgICBpZiAoIWl0ZW0pIHtcclxuICAgICAgICAgIHJldHVybiBlcnJvckhhbmRsZXIocmVxLCByZXMsIG5leHQpKG5ldyBFcnJvcihodHRwLlNUQVRVU19DT0RFU1s0MDRdKSlcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAobGV0IHByb3AgaW4gaXRlbSkge1xyXG4gICAgICAgICAgaXRlbVtwcm9wXSA9IHR5cGVvZiBpdGVtW3Byb3BdID09PSAnb2JqZWN0JyAmJiBwcm9wICE9PSAnX2lkJyA/IHRydWUgOiBpdGVtW3Byb3BdXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXEuZXJtLnJlc3VsdCA9IGl0ZW1cclxuICAgICAgICByZXEuZXJtLnN0YXR1c0NvZGUgPSAyMDBcclxuXHJcbiAgICAgICAgbmV4dCgpXHJcbiAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZGVsZXRlSXRlbXMgKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICBvcHRpb25zLmNvbnRleHRGaWx0ZXIobW9kZWwsIHJlcSwgKGZpbHRlcmVkQ29udGV4dCkgPT4ge1xyXG4gICAgICBidWlsZFF1ZXJ5KGZpbHRlcmVkQ29udGV4dC5yZW1vdmUoKSwgcmVxLl9lcm1RdWVyeU9wdGlvbnMpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgIHJlcS5lcm0uc3RhdHVzQ29kZSA9IDIwNFxyXG5cclxuICAgICAgICBuZXh0KClcclxuICAgICAgfSwgZXJyb3JIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KSlcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBnZXRJdGVtIChyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgaWYgKGlzRGlzdGluY3RFeGNsdWRlZChyZXEpKSB7XHJcbiAgICAgIHJlcS5lcm0ucmVzdWx0ID0gW11cclxuICAgICAgcmVxLmVybS5zdGF0dXNDb2RlID0gMjAwXHJcbiAgICAgIHJldHVybiBuZXh0KClcclxuICAgIH1cclxuXHJcbiAgICBvcHRpb25zLmNvbnRleHRGaWx0ZXIobW9kZWwsIHJlcSwgKGZpbHRlcmVkQ29udGV4dCkgPT4ge1xyXG4gICAgICBidWlsZFF1ZXJ5KGZpbmRCeUlkKGZpbHRlcmVkQ29udGV4dCwgcmVxLnBhcmFtcy5pZCksIHJlcS5fZXJtUXVlcnlPcHRpb25zKS50aGVuKChpdGVtKSA9PiB7XHJcbiAgICAgICAgaWYgKCFpdGVtKSB7XHJcbiAgICAgICAgICByZXR1cm4gZXJyb3JIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KShuZXcgRXJyb3IoaHR0cC5TVEFUVVNfQ09ERVNbNDA0XSkpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXEuZXJtLnJlc3VsdCA9IGl0ZW1cclxuICAgICAgICByZXEuZXJtLnN0YXR1c0NvZGUgPSAyMDBcclxuXHJcbiAgICAgICAgbmV4dCgpXHJcbiAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZGVsZXRlSXRlbSAocmVxLCByZXMsIG5leHQpIHtcclxuICAgIGlmIChvcHRpb25zLmZpbmRPbmVBbmRSZW1vdmUpIHtcclxuICAgICAgb3B0aW9ucy5jb250ZXh0RmlsdGVyKG1vZGVsLCByZXEsIChmaWx0ZXJlZENvbnRleHQpID0+IHtcclxuICAgICAgICBmaW5kQnlJZChmaWx0ZXJlZENvbnRleHQsIHJlcS5wYXJhbXMuaWQpLmZpbmRPbmVBbmRSZW1vdmUoKS50aGVuKChpdGVtKSA9PiB7XHJcbiAgICAgICAgICBpZiAoIWl0ZW0pIHtcclxuICAgICAgICAgICAgcmV0dXJuIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkobmV3IEVycm9yKGh0dHAuU1RBVFVTX0NPREVTWzQwNF0pKVxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHJlcS5lcm0uc3RhdHVzQ29kZSA9IDIwNFxyXG5cclxuICAgICAgICAgIG5leHQoKVxyXG4gICAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICAgIH0pXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXEuZXJtLmRvY3VtZW50LnJlbW92ZSgpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgIHJlcS5lcm0uc3RhdHVzQ29kZSA9IDIwNFxyXG5cclxuICAgICAgICBuZXh0KClcclxuICAgICAgfSwgZXJyb3JIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KSlcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGNyZWF0ZU9iamVjdCAocmVxLCByZXMsIG5leHQpIHtcclxuICAgIHJlcS5ib2R5ID0gb3B0aW9ucy5maWx0ZXIuZmlsdGVyT2JqZWN0KHJlcS5ib2R5IHx8IHt9LCB7XHJcbiAgICAgIGFjY2VzczogcmVxLmFjY2VzcyxcclxuICAgICAgcG9wdWxhdGU6IHJlcS5fZXJtUXVlcnlPcHRpb25zLnBvcHVsYXRlXHJcbiAgICB9KVxyXG5cclxuICAgIGlmIChtb2RlbC5zY2hlbWEub3B0aW9ucy5faWQpIHtcclxuICAgICAgZGVsZXRlIHJlcS5ib2R5Ll9pZFxyXG4gICAgfVxyXG5cclxuICAgIGlmIChtb2RlbC5zY2hlbWEub3B0aW9ucy52ZXJzaW9uS2V5KSB7XHJcbiAgICAgIGRlbGV0ZSByZXEuYm9keVttb2RlbC5zY2hlbWEub3B0aW9ucy52ZXJzaW9uS2V5XVxyXG4gICAgfVxyXG5cclxuICAgIG1vZGVsLmNyZWF0ZShyZXEuYm9keSkudGhlbigoaXRlbSkgPT4gbW9kZWwucG9wdWxhdGUoaXRlbSwgcmVxLl9lcm1RdWVyeU9wdGlvbnMucG9wdWxhdGUgfHwgW10pKS50aGVuKChpdGVtKSA9PiB7XHJcbiAgICAgIHJlcS5lcm0ucmVzdWx0ID0gaXRlbVxyXG4gICAgICByZXEuZXJtLnN0YXR1c0NvZGUgPSAyMDFcclxuXHJcbiAgICAgIG5leHQoKVxyXG4gICAgfSwgZXJyb3JIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KSlcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIG1vZGlmeU9iamVjdCAocmVxLCByZXMsIG5leHQpIHtcclxuICAgIHJlcS5ib2R5ID0gb3B0aW9ucy5maWx0ZXIuZmlsdGVyT2JqZWN0KHJlcS5ib2R5IHx8IHt9LCB7XHJcbiAgICAgIGFjY2VzczogcmVxLmFjY2VzcyxcclxuICAgICAgcG9wdWxhdGU6IHJlcS5fZXJtUXVlcnlPcHRpb25zLnBvcHVsYXRlXHJcbiAgICB9KVxyXG5cclxuICAgIGRlbGV0ZSByZXEuYm9keS5faWRcclxuXHJcbiAgICBpZiAobW9kZWwuc2NoZW1hLm9wdGlvbnMudmVyc2lvbktleSkge1xyXG4gICAgICBkZWxldGUgcmVxLmJvZHlbbW9kZWwuc2NoZW1hLm9wdGlvbnMudmVyc2lvbktleV1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBkZXBvcHVsYXRlIChzcmMpIHtcclxuICAgICAgbGV0IGRzdCA9IHt9XHJcblxyXG4gICAgICBmb3IgKGxldCBrZXkgaW4gc3JjKSB7XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IG1vZGVsLnNjaGVtYS5wYXRoKGtleSlcclxuXHJcbiAgICAgICAgaWYgKHBhdGggJiYgcGF0aC5jYXN0ZXIgJiYgcGF0aC5jYXN0ZXIuaW5zdGFuY2UgPT09ICdPYmplY3RJRCcpIHtcclxuICAgICAgICAgIGlmIChfLmlzQXJyYXkoc3JjW2tleV0pKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgc3JjW2tleV0ubGVuZ3RoOyArK2opIHtcclxuICAgICAgICAgICAgICBpZiAodHlwZW9mIHNyY1trZXldW2pdID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgZHN0W2tleV0gPSBkc3Rba2V5XSB8fCB7fVxyXG4gICAgICAgICAgICAgICAgZHN0W2tleV1bal0gPSBzcmNba2V5XVtqXS5faWRcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc1BsYWluT2JqZWN0KHNyY1trZXldKSkge1xyXG4gICAgICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldLl9pZFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoXy5pc1BsYWluT2JqZWN0KHNyY1trZXldKSkge1xyXG4gICAgICAgICAgaWYgKHBhdGggJiYgcGF0aC5pbnN0YW5jZSA9PT0gJ09iamVjdElEJykge1xyXG4gICAgICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldLl9pZFxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZHN0W2tleV0gPSBkZXBvcHVsYXRlKHNyY1trZXldKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQoZHN0W2tleV0pKSB7XHJcbiAgICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gZHN0XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY2xlYW5Cb2R5ID0gbW9yZWRvdHMoZGVwb3B1bGF0ZShyZXEuYm9keSkpXHJcblxyXG4gICAgaWYgKG9wdGlvbnMuZmluZE9uZUFuZFVwZGF0ZSkge1xyXG4gICAgICBvcHRpb25zLmNvbnRleHRGaWx0ZXIobW9kZWwsIHJlcSwgKGZpbHRlcmVkQ29udGV4dCkgPT4ge1xyXG4gICAgICAgIGZpbmRCeUlkKGZpbHRlcmVkQ29udGV4dCwgcmVxLnBhcmFtcy5pZCkuZmluZE9uZUFuZFVwZGF0ZSh7fSwge1xyXG4gICAgICAgICAgJHNldDogY2xlYW5Cb2R5XHJcbiAgICAgICAgfSwge1xyXG4gICAgICAgICAgbmV3OiB0cnVlLFxyXG4gICAgICAgICAgcnVuVmFsaWRhdG9yczogb3B0aW9ucy5ydW5WYWxpZGF0b3JzXHJcbiAgICAgICAgfSkuZXhlYygpLnRoZW4oKGl0ZW0pID0+IG1vZGVsLnBvcHVsYXRlKGl0ZW0sIHJlcS5fZXJtUXVlcnlPcHRpb25zLnBvcHVsYXRlIHx8IFtdKSkudGhlbigoaXRlbSkgPT4ge1xyXG4gICAgICAgICAgaWYgKCFpdGVtKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBlcnJvckhhbmRsZXIocmVxLCByZXMsIG5leHQpKG5ldyBFcnJvcihodHRwLlNUQVRVU19DT0RFU1s0MDRdKSlcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICByZXEuZXJtLnJlc3VsdCA9IGl0ZW1cclxuICAgICAgICAgIHJlcS5lcm0uc3RhdHVzQ29kZSA9IDIwMFxyXG5cclxuICAgICAgICAgIG5leHQoKVxyXG4gICAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICAgIH0pXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBmb3IgKGxldCBrZXkgaW4gY2xlYW5Cb2R5KSB7XHJcbiAgICAgICAgcmVxLmVybS5kb2N1bWVudC5zZXQoa2V5LCBjbGVhbkJvZHlba2V5XSlcclxuICAgICAgfVxyXG5cclxuICAgICAgcmVxLmVybS5kb2N1bWVudC5zYXZlKCkudGhlbigoaXRlbSkgPT4gbW9kZWwucG9wdWxhdGUoaXRlbSwgcmVxLl9lcm1RdWVyeU9wdGlvbnMucG9wdWxhdGUgfHwgW10pKS50aGVuKChpdGVtKSA9PiB7XHJcbiAgICAgICAgcmVxLmVybS5yZXN1bHQgPSBpdGVtXHJcbiAgICAgICAgcmVxLmVybS5zdGF0dXNDb2RlID0gMjAwXHJcblxyXG4gICAgICAgIG5leHQoKVxyXG4gICAgICB9LCBlcnJvckhhbmRsZXIocmVxLCByZXMsIG5leHQpKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHsgZ2V0SXRlbXMsIGdldENvdW50LCBnZXRJdGVtLCBnZXRTaGFsbG93LCBjcmVhdGVPYmplY3QsIG1vZGlmeU9iamVjdCwgZGVsZXRlSXRlbXMsIGRlbGV0ZUl0ZW0gfVxyXG59XHJcbiJdfQ==
//# sourceMappingURL=operations.js.map